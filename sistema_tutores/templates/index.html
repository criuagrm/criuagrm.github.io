<!doctype html>
<html lang="es" class="scroll-smooth">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Seguimiento al Practicum — UAGRM</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { 
            sans: ["Outfit", "sans-serif"], 
            display: ["Space Grotesk", "sans-serif"] 
          },
          colors: {
            'uagrm-red': '#cc0000',
            'uagrm-dark': '#0f172a',
          },
          animation: {
            'fade-in': 'fadeIn 0.5s ease-out forwards',
          },
          keyframes: {
            fadeIn: {
              '0%': { opacity: '0', transform: 'translateY(10px)' },
              '100%': { opacity: '1', transform: 'translateY(0)' },
            }
          }
        }
      }
    }
  </script>
  
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

  <style>
    .glass-card {
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid rgba(255, 255, 255, 0.5);
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    .snap-container { -webkit-overflow-scrolling: touch; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans antialiased overflow-x-hidden">

  <div id="main-view" class="relative min-h-screen flex flex-col justify-between transition-opacity duration-500">
    
    <nav class="absolute top-0 w-full z-40 p-4 lg:p-6 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 lg:w-10 lg:h-10 rounded-full bg-uagrm-red text-white flex items-center justify-center font-bold text-sm lg:text-lg shadow-lg">CP</div>
            <div>
                <h1 class="font-display font-bold text-slate-900 leading-tight text-sm lg:text-base">Ciencia Política y Adm. Pública</h1>
                <p class="text-[10px] lg:text-xs text-slate-500 uppercase tracking-widest">Gestión del Practicum</p>
            </div>
        </div>

        <a href="/login" class="flex items-center gap-2 px-4 py-2 bg-slate-900 text-white rounded-full text-xs font-bold hover:bg-slate-800 transition shadow-lg">
            <i class="fa-solid fa-right-to-bracket"></i>
            <span class="hidden sm:inline">Ingreso al Sistema</span>
        </a>
    </nav>

    <div class="flex-1 flex flex-col justify-start lg:justify-center pt-24 lg:pt-0 px-6 max-w-7xl mx-auto w-full z-10">
        <div class="max-w-2xl animate-fade-in">
            <span class="inline-block px-3 py-1 rounded-full bg-red-100 text-red-600 text-[10px] font-bold uppercase tracking-widest mb-4 border border-red-200">
                FCJPSRRII - UAGRM
            </span>
            <h2 class="font-display text-3xl md:text-5xl lg:text-6xl font-bold text-slate-900 mb-4 lg:mb-6 leading-tight">
                Sistema de seguimiento <br> <span class="text-uagrm-red">al Practicum</span>
            </h2>
            <p class="text-sm md:text-lg text-slate-600 mb-8 lg:mb-10 max-w-lg">
                Selecciona el Practicum en el cual estas inscrito para visualizar la disponibilidad de docentes y generar tu carta de solicitud de tutor.
            </p>
        </div>

        <div class="w-full mb-32 lg:mb-0"> 
            <div class="flex gap-4 lg:gap-6 overflow-x-auto snap-x snap-mandatory scrollbar-hide pb-4 snap-container">
                
                <div onclick="cargarNivel('II')" class="min-w-[85%] md:min-w-[300px] snap-center bg-white rounded-2xl p-5 border border-slate-200 shadow-sm hover:shadow-lg hover:border-red-200 transition cursor-pointer group relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-20 h-20 bg-red-50 rounded-bl-full -mr-4 -mt-4 transition group-hover:bg-red-100"></div>
                    <div class="relative z-10">
                        <div class="w-10 h-10 rounded-xl bg-slate-100 text-slate-600 flex items-center justify-center text-lg mb-3 group-hover:bg-red-600 group-hover:text-white transition"><i class="fa-solid fa-magnifying-glass"></i></div>
                        <h3 class="font-display text-xl font-bold text-slate-900">Practicum II</h3>
                    </div>
                </div>

                <div onclick="cargarNivel('III')" class="min-w-[85%] md:min-w-[300px] snap-center bg-white rounded-2xl p-5 border border-slate-200 shadow-sm hover:shadow-lg hover:border-red-200 transition cursor-pointer group relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-20 h-20 bg-blue-50 rounded-bl-full -mr-4 -mt-4 transition group-hover:bg-blue-100"></div>
                    <div class="relative z-10">
                        <div class="w-10 h-10 rounded-xl bg-slate-100 text-slate-600 flex items-center justify-center text-lg mb-3 group-hover:bg-blue-600 group-hover:text-white transition"><i class="fa-solid fa-pen-ruler"></i></div>
                        <h3 class="font-display text-xl font-bold text-slate-900">Practicum III</h3>
                    </div>
                </div>

                <div onclick="cargarNivel('IV')" class="min-w-[85%] md:min-w-[300px] snap-center bg-white rounded-2xl p-5 border border-slate-200 shadow-sm hover:shadow-lg hover:border-red-200 transition cursor-pointer group relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-20 h-20 bg-green-50 rounded-bl-full -mr-4 -mt-4 transition group-hover:bg-green-100"></div>
                    <div class="relative z-10">
                        <div class="w-10 h-10 rounded-xl bg-slate-100 text-slate-600 flex items-center justify-center text-lg mb-3 group-hover:bg-green-600 group-hover:text-white transition"><i class="fa-solid fa-graduation-cap"></i></div>
                        <h3 class="font-display text-xl font-bold text-slate-900">Practicum IV</h3>
                    </div>
                </div>

            </div>
            <p class="text-slate-400 text-xs text-center md:text-left animate-pulse mt-2 lg:hidden"><i class="fa-solid fa-arrow-right"></i> Desliza para ver</p>
        </div>
    </div>

    <div class="fixed bottom-0 right-0 z-0 pointer-events-none flex flex-col items-end justify-end">
        
        <img src="https://i.imgur.com/G6kesFp.png" 
             class="h-44 lg:h-[350px] w-auto object-contain drop-shadow-2xl translate-y-4 lg:translate-y-2 mr-0 lg:mr-0 opacity-100"
             alt="Director">
        
        <div class="absolute bottom-4 right-4 lg:bottom-8 lg:right-8 glass-card px-4 py-1.5 lg:px-8 lg:py-2 rounded-xl flex items-center gap-3 animate-fade-in shadow-lg">
            
            <div class="hidden lg:flex w-8 h-8 rounded bg-slate-900 items-center justify-center text-white text-xs">
                <i class="fa-solid fa-user-tie"></i>
            </div>
            
            <div class="leading-tight">
                <h4 class="font-display font-bold text-slate-900 text-[9px] lg:text-[10px] whitespace-nowrap">M.Sc. Odín Rodriguez</h4>
                <p class="text-[7px] lg:text-[8px] text-uagrm-red font-bold uppercase tracking-widest whitespace-nowrap">Director de Carrera</p>
            </div>
        </div>
    </div>

  </div>

  <div id="tutors-view" class="hidden min-h-screen bg-slate-50 pb-20">
      <div class="max-w-6xl mx-auto px-6 py-10">
          <div class="flex justify-between items-center mb-8">
              <div>
                <h2 class="font-display text-2xl lg:text-3xl font-bold text-slate-900" id="titulo-nivel">Practicum</h2>
                <p class="text-sm text-slate-500">Docentes habilitados</p>
              </div>
              <button onclick="volverInicio()" class="px-4 py-2 rounded-lg border border-slate-300 hover:bg-white transition text-xs font-bold text-slate-600 uppercase tracking-wide">
                  <i class="fa-solid fa-arrow-left mr-1"></i> Volver
              </button>
          </div>

          <div id="lista-tutores" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 lg:gap-6"></div>
      </div>
  </div>

  <div id="modal" class="fixed inset-0 z-50 hidden">
      <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm transition-opacity" onclick="cerrarModal()"></div>
      <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-sm p-4">
          <div class="bg-white rounded-2xl shadow-2xl overflow-hidden">
              <div class="bg-slate-900 p-5 text-white relative">
                  <h3 class="font-display text-lg font-bold">Confirmar Solicitud</h3>
                  <p class="text-slate-400 text-xs mt-0.5">Practicum <span id="modal-nivel"></span></p>
                  <button onclick="cerrarModal()" class="absolute top-4 right-4 text-slate-400 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
              </div>
              
              <div class="p-5">
                  <div class="flex items-center gap-3 mb-4 p-3 bg-slate-50 rounded-xl border border-slate-100">
                      <div class="w-8 h-8 rounded-full bg-uagrm-red/10 text-uagrm-red flex items-center justify-center font-bold text-sm"><i class="fa-solid fa-user-check"></i></div>
                      <div>
                          <p class="text-[10px] text-slate-500 uppercase font-bold">Tutor de Tesis:</p>
                          <span class="font-bold text-slate-900 text-sm leading-tight" id="modal-tutor-nombre"></span>
                      </div>
                  </div>

                  <form id="formSolicitud" onsubmit="enviarSolicitud(event)">
                      <input type="hidden" id="input-tutor-id">
                      
                      <div class="mb-4">
                          <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Docente de Materia / Turno</label>
                          <select id="input-docente-materia" required class="w-full px-4 py-3 rounded-xl bg-blue-50 border border-blue-200 text-sm font-bold text-slate-700 focus:outline-none focus:border-blue-500 transition cursor-pointer">
                              <option value="">Cargando docentes...</option>
                          </select>
                          <p class="text-[10px] text-slate-400 mt-1 pl-1">Selecciona el grupo en el que inscribiste la materia.</p>
                      </div>

                      <div class="space-y-3">
                          <div>
                              <label class="block text-xs font-bold text-slate-400 uppercase mb-1 ml-1">Nombre Completo</label>
                              <input type="text" id="input-nombre" required class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200 text-sm focus:outline-none focus:border-uagrm-red focus:ring-1 focus:ring-uagrm-red transition" placeholder="Ej: Juan Pérez">
                          </div>
                          <div>
                              <label class="block text-xs font-bold text-slate-400 uppercase mb-1 ml-1">Registro Universitario</label>
                              <input type="number" id="input-registro" required class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200 text-sm focus:outline-none focus:border-uagrm-red focus:ring-1 focus:ring-uagrm-red transition" placeholder="Ej: 219000000">
                          </div>
                          <div>
                              <label class="block text-xs font-bold text-slate-400 uppercase mb-1 ml-1">Cédula de Identidad</label>
                              <input type="text" id="input-carnet" required class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200 text-sm focus:outline-none focus:border-uagrm-red focus:ring-1 focus:ring-uagrm-red transition" placeholder="Ej: 8999123">
                          </div>
                      </div>

                      <div class="mt-4 p-3 bg-yellow-50 text-yellow-800 text-xs rounded-lg border border-yellow-100 flex items-start gap-2">
                          <i class="fa-solid fa-circle-info mt-0.5"></i> 
                          <span>Tu solicitud quedará <strong>PENDIENTE</strong> hasta que entregues la carta física en Dirección de Carrera.</span>
                      </div>

                      <button type="submit" class="w-full mt-4 py-3 bg-uagrm-red text-white font-bold rounded-xl shadow-lg shadow-red-200 hover:bg-red-700 transition text-sm uppercase tracking-wide transform active:scale-95">
                          Generar Carta y Reservar
                      </button>
                  </form>
              </div>
          </div>
      </div>
  </div>

  <script>
    let nivelActual = "";
    let docentesCache = []; // Almacenamos la lista de profes aquí

    // 1. Cargar lista de docentes al iniciar la página
    window.onload = async () => {
        try {
            const res = await fetch('/api/docentes_materia');
            docentesCache = await res.json();
        } catch(e) { console.error("Error cargando docentes materia"); }
    };

    function cargarNivel(nivel) {
        nivelActual = nivel;
        document.getElementById('main-view').classList.add('hidden');
        document.getElementById('tutors-view').classList.remove('hidden');
        document.getElementById('titulo-nivel').innerText = `Practicum ${nivel}`;
        window.scrollTo(0,0);
        fetchTutores();
    }

    function volverInicio() {
        document.getElementById('tutors-view').classList.add('hidden');
        document.getElementById('main-view').classList.remove('hidden');
        document.getElementById('lista-tutores').innerHTML = ''; 
    }

    async function fetchTutores() {
        const contenedor = document.getElementById('lista-tutores');
        contenedor.innerHTML = '<div class="col-span-3 text-center py-10"><div class="inline-block w-6 h-6 border-2 border-slate-200 border-t-uagrm-red rounded-full animate-spin"></div></div>';

        try {
            const res = await fetch(`/api/tutors?level=${nivelActual}`);
            const tutores = await res.json();
            
            contenedor.innerHTML = "";
            
            if(tutores.length === 0) {
                contenedor.innerHTML = '<div class="col-span-3 text-center text-slate-500 text-sm">No hay docentes disponibles.</div>';
                return;
            }

            tutores.forEach(t => {
                const lleno = t.cupos_disponibles === 0;
                const card = document.createElement('div');
                card.className = `bg-white p-5 rounded-xl border ${lleno ? 'border-slate-100 opacity-60' : 'border-slate-200 hover:border-uagrm-red hover:shadow-md'} transition group relative overflow-hidden`;
                
                if(!lleno) {
                    card.onclick = () => abrirModal(t.id, t.name);
                    card.style.cursor = 'pointer';
                }

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div class="w-10 h-10 rounded-lg bg-slate-50 flex items-center justify-center text-base text-slate-700 font-bold">
                            ${t.name.charAt(0)}
                        </div>
                        <span class="${lleno ? 'bg-slate-100 text-slate-400' : 'bg-green-50 text-green-700'} px-2 py-1 rounded-md text-[10px] font-bold uppercase">
                            ${lleno ? 'Agotado' : `${t.cupos_disponibles} Libres`}
                        </span>
                    </div>
                    <h3 class="font-display font-bold text-slate-900 text-base mb-1 leading-tight line-clamp-1">${t.name}</h3>
                    <div class="space-y-1 mt-3 border-t border-slate-50 pt-3">
                        <p class="text-xs text-slate-500 flex items-center gap-2"><i class="fa-solid fa-phone text-[10px] text-slate-300"></i> ${t.phone}</p>
                        <p class="text-xs text-slate-500 flex items-center gap-2 line-clamp-1"><i class="fa-solid fa-envelope text-[10px] text-slate-300"></i> ${t.email}</p>
                    </div>
                `;
                contenedor.appendChild(card);
            });

        } catch (error) {
            contenedor.innerHTML = '<div class="col-span-3 text-center text-red-500 text-sm">Error de conexión.</div>';
        }
    }

    const modal = document.getElementById('modal');
    
    function abrirModal(id, nombre) {
        document.getElementById('input-tutor-id').value = id;
        document.getElementById('modal-tutor-nombre').innerText = nombre;
        document.getElementById('modal-nivel').innerText = nivelActual;
        
        // 2. Filtrar el select de docentes según el nivel actual
        const select = document.getElementById('input-docente-materia');
        select.innerHTML = '<option value="">-- Selecciona tu Turno --</option>';
        
        const nivelRomano = nivelActual; // Ej: "II"
        
        // Filtramos solo los profes que tengan "Practicum II" en su nombre
        const docentesFiltrados = docentesCache.filter(d => d.name.includes(`Practicum ${nivelRomano}`));
        
        if(docentesFiltrados.length === 0) {
             const opt = document.createElement('option');
             opt.innerText = "No se encontraron docentes para este nivel";
             select.appendChild(opt);
        } else {
            docentesFiltrados.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d.id;
                opt.innerText = d.name; // Ej: "Practicum II - Turno Mañana"
                select.appendChild(opt);
            });
        }

        modal.classList.remove('hidden');
    }
    
    function cerrarModal() { modal.classList.add('hidden'); }

    async function enviarSolicitud(e) {
        e.preventDefault();
        const btn = e.target.querySelector('button');
        const txtOriginal = btn.innerText;
        btn.disabled = true;
        btn.innerText = "Procesando...";

        const datos = {
            tutor_id: parseInt(document.getElementById('input-tutor-id').value),
            docente_id: document.getElementById('input-docente-materia').value, // DATO NUEVO
            nivel: nivelActual,
            nombre: document.getElementById('input-nombre').value,
            registro: document.getElementById('input-registro').value,
            carnet: document.getElementById('input-carnet').value
        };

        try {
            const res = await fetch('/api/solicitar', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(datos)
            });
            const json = await res.json();

            if (res.ok) {
                // Descarga automática
                window.location.href = json.pdf_url;
                
                alert("¡SOLICITUD REGISTRADA!\n\n1. Se está descargando tu carta.\n2. Imprímela y llévala a Dirección de Carrera.\n3. Cuando sea aprobada, podrás ingresar al sistema con tu Registro y Carnet.");
                
                cerrarModal();
                fetchTutores();
                e.target.reset();
            } else {
                alert("Error: " + json.error);
            }
        } catch (err) {
            alert("Error de conexión");
        } finally {
            btn.disabled = false;
            btn.innerText = txtOriginal;
        }
    }
  </script>
</body>
</html>
