<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CIRCPyCS — Atlas de Inteligencia Territorial 2024</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root { --primary: #004494; --dark: #0f172a; --bg: #f8fafc; --accent: #f59e0b; }
        body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; background: var(--bg); overflow: hidden; color: var(--dark); }
        #mapa { width: 100vw; height: 100vh; z-index: 1; }

        /* HEADER INSTITUCIONAL MEJORADO */
        #header {
            position: absolute; top: 15px; left: 15px; z-index: 1000;
            background: rgba(255,255,255,0.95); backdrop-filter: blur(8px);
            padding: 10px 20px; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 15px;
            flex-wrap: wrap;
        }
        #header img { height: 35px; }
        #header-text h1 { margin: 0; font-size: 13px; color: var(--primary); text-transform: uppercase; font-weight: 800; }
        #header-text p { margin: 0; font-size: 10px; color: #64748b; }

        /* BUSCADOR DE CIUDADES */
        .search-container {
            display: flex; align-items: center; background: #f1f5f9; 
            border-radius: 8px; padding: 5px 10px; margin-left: 10px; border: 1px solid #e2e8f0;
        }
        .search-container i { color: var(--primary); margin-right: 8px; font-size: 14px; }
        .search-container select {
            border: none; background: transparent; outline: none; font-family: 'Inter';
            font-size: 12px; color: var(--dark); width: 150px; cursor: pointer;
        }

        /* BOTÓN ACERCA DE */
        .btn-info {
            background: var(--primary); color: white; border: none; padding: 6px 12px;
            border-radius: 6px; font-size: 11px; font-weight: 700; cursor: pointer;
            transition: 0.2s; display: flex; align-items: center; gap: 6px; margin-left: auto;
        }
        .btn-info:hover { background: #003377; }

        /* MODAL (DISCLAIMER) */
        #modal-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(4px);
            z-index: 9999; display: none; align-items: center; justify-content: center;
        }
        .modal-card {
            background: white; width: 90%; max-width: 500px; border-radius: 16px;
            padding: 30px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); position: relative;
        }
        .modal-close {
            position: absolute; top: 15px; right: 15px; background: none; border: none;
            font-size: 20px; color: #64748b; cursor: pointer;
        }
        .modal-card h2 { margin-top: 0; color: var(--primary); font-size: 20px; }
        .modal-card h3 { font-size: 14px; color: var(--dark); margin-top: 20px; border-bottom: 2px solid #f1f5f9; padding-bottom: 5px;}
        .modal-card p { font-size: 13px; color: #475569; line-height: 1.6; text-align: justify;}
        .modal-card a { color: var(--accent); text-decoration: none; font-weight: 700; }
        .modal-card a:hover { text-decoration: underline; }

        /* PANEL LATERAL */
        #side-panel {
            position: absolute; right: 0; top: 0; width: 420px; height: 100vh;
            background: white; z-index: 1001; box-shadow: -5px 0 25px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .btn-cerrar {
            position: absolute; top: 15px; right: 15px; background: #f1f5f9; border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; display: none; align-items: center; justify-content: center;
        }
        @media (max-width: 768px) {
            #side-panel { width: 100%; height: 80vh; top: auto; bottom: 0; transform: translateY(100%); border-radius: 24px 24px 0 0; }
            #side-panel.active { transform: translateY(0); }
            .btn-cerrar { display: flex; }
            .search-container { margin-left: 0; margin-top: 10px; width: 100%; }
            .search-container select { width: 100%; }
            .btn-info { margin-top: 10px; width: 100%; justify-content: center; }
        }
        .panel-scroll { flex-grow: 1; overflow-y: auto; padding: 30px; }
        
        /* ESTILOS DE FICHAS */
        .category-title { background: #f1f5f9; padding: 10px 15px; border-radius: 8px; font-size: 11px; font-weight: 800; color: var(--primary); text-transform: uppercase; margin: 30px 0 15px 0; display: flex; align-items: center; gap: 10px; }
        .category-title:first-child { margin-top: 0; }
        .data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .data-card { background: #fff; border: 1px solid #e2e8f0; padding: 12px; border-radius: 10px; }
        .data-label { font-size: 9px; color: #64748b; font-weight: 700; text-transform: uppercase; margin-bottom: 4px; }
        .data-value { font-size: 18px; font-weight: 800; }
        .progress-box { margin-bottom: 14px; background: #fff; border: 1px solid #f1f5f9; padding: 12px; border-radius: 10px; }
        .progress-label { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 6px; font-weight: 600; }
        .progress-bg { height: 6px; background: #e2e8f0; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); transition: width 0.8s ease; }

        #welcome-msg { padding: 100px 40px; text-align: center; color: #94a3b8; }
    </style>
</head>
<body>

    <div id="modal-overlay">
        <div class="modal-card">
            <button class="modal-close" onclick="cerrarModal()"><i class="fa-solid fa-xmark"></i></button>
            <h2>CIRCPyCS — UAGRM</h2>
            <p>El <strong>Centro de Investigación Regional en Ciencia Política y Ciencias Sociales</strong> presenta este Atlas Interactivo como herramienta para la visualización y análisis de los datos del Censo de Población y Vivienda 2024 a nivel de manzano.</p>
            
            <h3><i class="fa-solid fa-code-branch"></i> Metodología y Fuentes</h3>
            <p>La fuente primaria de información corresponde al <strong>Instituto Nacional de Estadística (INE)</strong> de Bolivia.</p>
            <p>El proceso de extracción, limpieza y consolidación de la base de datos cruda a formato GeoJSON comprimido fue diseñado originalmente por el ingeniero de datos <strong>Mauricio Foronda</strong>. Reconocemos su valioso aporte al código abierto. <br>
            <a href="https://github.com/mauforonda" target="_blank"><i class="fa-brands fa-github"></i> Ver repositorio original en GitHub</a></p>

            <h3><i class="fa-solid fa-laptop-code"></i> Procesamiento Analítico</h3>
            <p>El diseño de la interfaz, el cálculo de indicadores sociodemográficos avanzados y la adaptación espacial de la plataforma fueron desarrollados por el equipo de investigación del <strong>CIRCPyCS</strong>.</p>
        </div>
    </div>

    <div id="header">
        <img src="https://i.imgur.com/ldeXZmG.png" alt="CIRCPyCS">
        <div id="header-text">
            <h1>CIRCPyCS</h1>
            <p>Atlas Censo 2024</p>
        </div>
        
        <div class="search-container">
            <i class="fa-solid fa-magnifying-glass"></i>
            <select id="buscador-ciudades" onchange="volarACiudad(this.value)">
                <option value="">Buscar ciudad...</option>
                </select>
        </div>

        <button class="btn-info" onclick="abrirModal()">
            <i class="fa-solid fa-circle-info"></i> Acerca de
        </button>
    </div>

    <div id="side-panel">
        <button class="btn-cerrar" onclick="cerrarPanel()"><i class="fa-solid fa-xmark"></i></button>
        <div id="welcome-msg"><i class="fa-solid fa-database fa-4x" style="margin-bottom:15px"></i><p>Seleccione un manzano o busque una ciudad para visualizar su perfil sociodemográfico.</p></div>

        <div id="panel-content" class="panel-scroll" style="display: none;">
            <div class="category-title"><i class="fa-solid fa-users"></i> Demografía</div>
            <div class="data-grid">
                <div class="data-card"><div class="data-label">Población</div><div class="data-value" id="v-personas">0</div></div>
                <div class="data-card"><div class="data-label">Densidad</div><div class="data-value" id="v-densidad">0</div></div>
                <div class="data-card"><div class="data-label">Masculinidad</div><div class="data-value" id="v-masculinidad">0</div></div>
                <div class="data-card"><div class="data-label">Migrantes</div><div class="data-value" id="v-migrante">0%</div></div>
            </div>

            <div class="category-title"><i class="fa-solid fa-graduation-cap"></i> Educación y Salud</div>
            <div class="progress-box"><div class="progress-label"><span>Educación Superior</span> <span id="t-edu">0%</span></div><div class="progress-bg"><div id="b-edu" class="progress-fill"></div></div></div>
            <div class="progress-box"><div class="progress-label"><span>Seguro Privado</span> <span id="t-seguro">0%</span></div><div class="progress-bg"><div id="b-seguro" class="progress-fill" style="background:#ec4899"></div></div></div>

            <div class="category-title"><i class="fa-solid fa-house"></i> Vivienda y Servicios</div>
            <div class="progress-box"><div class="progress-label"><span>Agua</span> <span id="t-agua">0%</span></div><div class="progress-bg"><div id="b-agua" class="progress-fill"></div></div></div>
            <div class="progress-box"><div class="progress-label"><span>Internet</span> <span id="t-net">0%</span></div><div class="progress-bg"><div id="b-net" class="progress-fill" style="background:#0ea5e9"></div></div></div>

            <div class="category-title"><i class="fa-solid fa-briefcase"></i> Economía</div>
            <div class="data-card" style="margin-bottom:15px"><div class="data-label">Dependencia Económica</div><div class="data-value" id="v-dependencia">0%</div></div>
        </div>
    </div>

    <div id="mapa"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // 1. CONFIGURACIÓN DEL MAPA Y CAPAS BASE
        const mapaClaro = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: 'CIRCPyCS — CartoDB' });
        const mapaSatelite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri Satellite' });
        const mapaCalles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'OpenStreetMap' });

        const map = L.map('mapa', { 
            zoomControl: false, 
            layers: [mapaClaro],
            tap: true 
        }).setView([-17.7833, -63.1821], 12);
        
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        const capasBase = {
            "Mapa Limpio (Carto)": mapaClaro,
            "Vista Satelital (Esri)": mapaSatelite,
            "Calles (OSM)": mapaCalles
        };
        L.control.layers(capasBase, null, {position: 'bottomleft'}).addTo(map);

        let traductor = {};
        let layerActiva = null;

        // 2. DETECTOR DE ERRORES AL CARGAR DATOS
        fetch('campos.json')
            .then(res => {
                if(!res.ok) throw new Error("No se pudo cargar campos.json");
                return res.json();
            })
            .then(data => {
                for (let k in data) { traductor[data[k]] = k; }
                cargarMapa();
                cargarBuscadorCiudades();
            })
            .catch(error => {
                alert("⚠️ Error de seguridad detectado. El mapa está en blanco porque Chrome bloquea los archivos si los abres con doble clic. \n\nSolución: Debes abrir la terminal en esta carpeta y ejecutar 'python -m http.server 8000' y luego entrar a localhost:8000 en tu navegador.");
                console.error(error);
            });

        function cargarMapa() {
            fetch('manzanos.geojson')
                .then(res => res.json())
                .then(geojson => {
                    L.geoJSON(geojson, {
                        style: { color: '#004494', weight: 0.8, fillOpacity: 0.2 },
                        onEachFeature: (f, l) => {
                            l.on('click', (e) => {
                                if(layerActiva) layerActiva.setStyle({weight: 0.8, color: '#004494', fillOpacity: 0.2});
                                l.setStyle({weight: 3, color: '#f59e0b', fillOpacity: 0.5});
                                layerActiva = l;
                                mostrarFicha(f.properties);
                            });
                        }
                    }).addTo(map);
                })
                .catch(e => console.error("Error al cargar manzanos.geojson", e));
        }

        function cargarBuscadorCiudades() {
            fetch('ciudades.json').then(res => res.json()).then(ciudades => {
                ciudades.sort((a, b) => a.nombre.localeCompare(b.nombre));
                const select = document.getElementById('buscador-ciudades');
                ciudades.forEach(c => {
                    let option = document.createElement('option');
                    option.value = `${c.y},${c.x}`;
                    option.textContent = `${c.nombre} (${c.municipio})`;
                    select.appendChild(option);
                });
            }).catch(e => console.log("No se encontró ciudades.json", e));
        }

        function volarACiudad(coords) {
            if (!coords) return;
            const [lat, lng] = coords.split(',');
            map.flyTo([lat, lng], 14, { duration: 1.5 });
        }

        function mostrarFicha(p) {
            let d = {};
            for (let k in p) { if(traductor[k]) d[traductor[k]] = p[k]; }
            document.getElementById('welcome-msg').style.display = 'none';
            document.getElementById('panel-content').style.display = 'block';
            document.getElementById('side-panel').classList.add('active');

            const up = (id, val, isPerc = true) => {
                let v = val || 0;
                let disp = isPerc ? Math.round(v * 100) : Math.round(v);
                if(document.getElementById('v-'+id)) document.getElementById('v-'+id).innerText = disp + (isPerc ? "%" : "");
                if(document.getElementById('t-'+id)) document.getElementById('t-'+id).innerText = disp + "%";
                if(document.getElementById('b-'+id)) document.getElementById('b-'+id).style.width = Math.min(disp, 100) + "%";
            };

            up('personas', d.personas, false);
            up('densidad', d.personas_por_hectarea, false);
            up('masculinidad', d.masculinidad, false);
            up('migrante', d.poblacion_migrante);
            up('edu', d.educacion_superior);
            up('seguro', d.seguro_privado);
            up('agua', d.viviendas_agua_cañería);
            up('net', d.viviendas_tics_internet);
            up('dependencia', d.dependencia_economica / 100);
        }

        function cerrarPanel() { document.getElementById('side-panel').classList.remove('active'); }
        function abrirModal() { document.getElementById('modal-overlay').style.display = 'flex'; }
        function cerrarModal() { document.getElementById('modal-overlay').style.display = 'none'; }
    </script>
</body>
</html>
