<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CIRCPyCS — Atlas de Inteligencia Territorial 2024</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root { 
            --primary: #004494; 
            --dark: #0f172a; 
            --bg: #f8fafc; 
            --accent: #f59e0b;
            --success: #22c55e;
            --danger: #ef4444;
        }

        body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; background: var(--bg); overflow: hidden; color: var(--dark); }
        #mapa { width: 100vw; height: 100vh; z-index: 1; }

        /* HEADER INSTITUCIONAL */
        #header {
            position: absolute; top: 15px; left: 15px; z-index: 1000;
            background: white; padding: 10px 20px; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 15px;
            max-width: calc(100vw - 30px);
        }
        #header img { height: 35px; }
        #header h1 { margin: 0; font-size: 13px; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; font-weight: 800; }

        /* PANEL LATERAL RESPONSIVO */
        #side-panel {
            position: absolute; right: 0; top: 0; width: 420px; height: 100vh;
            background: white; z-index: 1001; box-shadow: -5px 0 25px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-cerrar {
            position: absolute; top: 15px; right: 15px; background: #f1f5f9;
            border: none; width: 35px; height: 35px; border-radius: 50%;
            cursor: pointer; display: none; align-items: center; justify-content: center; color: var(--dark);
        }

        @media (max-width: 768px) {
            #side-panel {
                width: 100%; height: 75vh; top: auto; bottom: 0;
                transform: translateY(100%); border-radius: 24px 24px 0 0;
            }
            #side-panel.active { transform: translateY(0); }
            .btn-cerrar { display: flex; z-index: 1002; }
            #header h1 span { display: none; }
        }

        .panel-scroll { flex-grow: 1; overflow-y: auto; padding: 30px; }
        
        /* DISEÑO DE FICHA TÉCNICA "CHE" */
        .category-title { 
            background: #f1f5f9; padding: 10px 15px; border-radius: 8px;
            font-size: 11px; font-weight: 800; color: var(--primary);
            text-transform: uppercase; margin: 30px 0 15px 0; display: flex; align-items: center; gap: 10px;
        }
        .category-title:first-child { margin-top: 0; }
        
        .data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .data-card { background: #fff; border: 1px solid #e2e8f0; padding: 12px; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.02); }
        .data-label { font-size: 9px; color: #64748b; font-weight: 700; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
        .data-value { font-size: 18px; font-weight: 800; color: var(--dark); }
        
        .progress-box { margin-bottom: 14px; background: #fff; border: 1px solid #f1f5f9; padding: 12px; border-radius: 10px; }
        .progress-label { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 6px; font-weight: 600; }
        .progress-bg { height: 6px; background: #e2e8f0; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); border-radius: 4px; transition: width 0.8s cubic-bezier(0.17, 0.67, 0.83, 0.67); }

        #welcome-msg { padding: 120px 40px; text-align: center; color: #94a3b8; }
        #welcome-msg i { color: #cbd5e1; margin-bottom: 20px; }
    </style>
</head>
<body>

    <div id="header">
        <img src="https://i.imgur.com/ldeXZmG.png" alt="CIRCPyCS">
        <h1>CIRCPyCS <span>— Atlas del Censo 2024</span></h1>
    </div>

    <div id="side-panel">
        <button class="btn-cerrar" onclick="cerrarPanel()"><i class="fa-solid fa-xmark"></i></button>
        
        <div id="welcome-msg">
            <i class="fa-solid fa-database fa-4x"></i>
            <p>Seleccione un manzano para visualizar la ficha técnica completa del Censo 2024.</p>
        </div>

        <div id="panel-content" class="panel-scroll" style="display: none;">
            
            <div class="category-title"><i class="fa-solid fa-people-group"></i> Demografía y Estructura</div>
            <div class="data-grid">
                <div class="data-card"><div class="data-label">Población Total</div><div class="data-value" id="val-personas">0</div></div>
                <div class="data-card"><div class="data-label">Densidad (Hab/Ha)</div><div class="data-value" id="val-densidad">0</div></div>
                <div class="data-card"><div class="data-label">Índice Masculinidad</div><div class="data-value" id="val-masculinidad">0</div></div>
                <div class="data-card"><div class="data-label">Pob. Migrante</div><div class="data-value" id="val-migrante">0%</div></div>
            </div>
            <div class="data-grid">
                <div class="progress-box"><div class="progress-label"><span>Menores 20 años</span> <span id="txt-jovenes">0%</span></div><div class="progress-bg"><div id="bar-jovenes" class="progress-fill" style="background: var(--success);"></div></div></div>
                <div class="progress-box"><div class="progress-label"><span>Mayores 60 años</span> <span id="txt-ancianos">0%</span></div><div class="progress-bg"><div id="bar-ancianos" class="progress-fill" style="background: var(--danger);"></div></div></div>
            </div>

            <div class="category-title"><i class="fa-solid fa-graduation-cap"></i> Educación y Salud</div>
            <div class="progress-box"><div class="progress-label"><span>Educación Superior</span> <span id="txt-edu">0%</span></div><div class="progress-bg"><div id="bar-edu" class="progress-fill" style="background: #8b5cf6;"></div></div></div>
            <div class="progress-box"><div class="progress-label"><span>Brecha Género Ed.</span> <span id="txt-brechaedu">0%</span></div><div class="progress-bg"><div id="bar-brechaedu" class="progress-fill" style="background: #a855f7;"></div></div></div>
            <div class="progress-box"><div class="progress-label"><span>Seguro Privado</span> <span id="txt-seguro">0%</span></div><div class="progress-bg"><div id="bar-seguro" class="progress-fill" style="background: #ec4899;"></div></div></div>
            <div class="progress-box"><div class="progress-label"><span>Brecha Género Seguro</span> <span id="txt-brechaseg">0%</span></div><div class="progress-bg"><div id="bar-brechaseg" class="progress-fill" style="background: #db2777;"></div></div></div>

            <div class="category-title"><i class="fa-solid fa-faucet-drip"></i> Vivienda y Servicios Básicos</div>
            <div class="data-grid">
                <div class="data-card"><div class="data-label">Viviendas Desocupadas</div><div class="data-value" id="val-desocupadas">0%</div></div>
                <div class="data-card"><div class="data-label">Alquiler/Anticrético</div><div class="data-value" id="val-alquiler">0%</div></div>
            </div>
            <div class="progress-box"><div class="progress-label"><span>Energía Eléctrica</span> <span id="txt-luz">0%</span></div><div class="progress-bg"><div id="bar-luz" class="progress-fill" style="background: #eab308;"></div></div></div>
            <div class="progress-box"><div class="progress-label"><span>Agua por Cañería</span> <span id="txt-agua">0%</span></div><div class="progress-bg"><div id="bar-agua" class="progress-fill"></div></div></div>
            <div class="progress-box"><div class="progress-label"><span>Alcantarillado</span> <span id="txt-cloaca">0%</span></div><div class="progress-bg"><div id="bar-cloaca" class="progress-fill"></div></div></div>
            <div class="progress-box"><div class="progress-label"><span>Gas por Cañería</span> <span id="txt-gas">0%</span></div><div class="progress-bg"><div id="bar-gas" class="progress-fill" style="background: #f97316;"></div></div></div>
            <div class="progress-box"><div class="progress-label"><span>Acceso a Internet</span> <span id="txt-internet">0%</span></div><div class="progress-bg"><div id="bar-internet" class="progress-fill" style="background: #0ea5e9;"></div></div></div>

            <div class="category-title"><i class="fa-solid fa-briefcase"></i> Perfil Laboral y Económico</div>
            <div class="progress-box"><div class="progress-label"><span>Dependencia Económica</span> <span id="txt-dependencia">0%</span></div><div class="progress-bg"><div id="bar-dependencia" class="progress-fill" style="background: #64748b;"></div></div></div>
            <div class="data-grid">
                <div class="data-card"><div class="data-label">Asalariados (Emp/Obr)</div><div class="data-value" id="val-empleados">0%</div></div>
                <div class="data-card"><div class="data-label">Cuentapropistas</div><div class="data-value" id="val-cuenta">0%</div></div>
            </div>

            <div class="category-title"><i class="fa-solid fa-chart-pie"></i> Actividades Económicas</div>
            <div class="progress-box"><div class="progress-label"><span>Agricultura / Ganadería</span> <span id="txt-agri">0%</span></div><div class="progress-bg"><div id="bar-agri" class="progress-fill" style="background: #15803d;"></div></div></div>
            <div class="progress-box"><div class="progress-label"><span>Comercio</span> <span id="txt-com">0%</span></div><div class="progress-bg"><div id="bar-com" class="progress-fill" style="background: #1d4ed8;"></div></div></div>
            <div class="progress-box"><div class="progress-label"><span>Industria</span> <span id="txt-man">0%</span></div><div class="progress-bg"><div id="bar-man" class="progress-fill" style="background: #b91c1c;"></div></div></div>
            <div class="progress-box"><div class="progress-label"><span>Construcción</span> <span id="txt-cons">0%</span></div><div class="progress-bg"><div id="bar-cons" class="progress-fill" style="background: #d97706;"></div></div></div>
            <div class="progress-box"><div class="progress-label"><span>Transporte</span> <span id="txt-trans">0%</span></div><div class="progress-bg"><div id="bar-trans" class="progress-fill" style="background: #4b5563;"></div></div></div>
            <div class="progress-box"><div class="progress-label"><span>Enseñanza</span> <span id="txt-edu2">0%</span></div><div class="progress-bg"><div id="bar-edu2" class="progress-fill" style="background: #6d28d9;"></div></div></div>
        </div>
    </div>

    <div id="mapa"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const map = L.map('mapa', { zoomControl: false, tap: true }).setView([-17.7833, -63.1821], 12);
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: 'CIRCPyCS — UAGRM'
        }).addTo(map);

        let traductor = {};
        let layerActiva = null;

        // 1. CARGAR Y INVERTIR DICCIONARIO
        fetch('campos.json').then(res => res.json()).then(data => {
            for (let k in data) { traductor[data[k]] = k; }
            cargarMapa();
        });

        // 2. CARGAR GEOMETRÍA
        function cargarMapa() {
            fetch('manzanos.geojson').then(res => res.json()).then(geojson => {
                L.geoJSON(geojson, {
                    style: { color: '#004494', weight: 0.8, fillOpacity: 0.2 },
                    onEachFeature: (f, l) => {
                        l.on('click', (e) => {
                            L.DomEvent.stopPropagation(e);
                            if(layerActiva) layerActiva.setStyle({weight: 0.8, color: '#004494', fillOpacity: 0.2});
                            l.setStyle({weight: 3, color: '#f59e0b', fillOpacity: 0.4});
                            layerActiva = l;
                            mostrarFicha(f.properties);
                        });
                    }
                }).addTo(map);
            });
        }

        // 3. MOSTRAR DATOS
        function mostrarFicha(p) {
            let d = {};
            for (let k in p) { if(traductor[k]) d[traductor[k]] = p[k]; }

            document.getElementById('welcome-msg').style.display = 'none';
            document.getElementById('panel-content').style.display = 'block';
            document.getElementById('side-panel').classList.add('active');

            const updateUI = (id, val, isPerc = true) => {
                let v = val || 0;
                let displayVal = isPerc ? Math.round(v * 100) : Math.round(v);
                
                if(document.getElementById('val-'+id)) document.getElementById('val-'+id).innerText = displayVal + (isPerc ? "%" : "");
                if(document.getElementById('txt-'+id)) document.getElementById('txt-'+id).innerText = displayVal + "%";
                
                let bar = document.getElementById('bar-'+id);
                if(bar) {
                    let width = isPerc ? Math.min(displayVal, 100) : 0;
                    bar.style.width = width + "%";
                    // Alerta visual si supera el 100% (razón estadística)
                    bar.style.boxShadow = displayVal > 100 ? "0 0 8px #ef4444" : "none";
                }
            };

            // Mapeo masivo de variables
            updateUI('personas', d.personas, false);
            updateUI('densidad', d.personas_por_hectarea, false);
            updateUI('masculinidad', d.masculinidad, false);
            updateUI('migrante', d.poblacion_migrante);
            updateUI('jovenes', d.porcentaje_menor20);
            updateUI('ancianos', d.porcentaje_60omas);
            updateUI('edu', d.educacion_superior);
            updateUI('brechaedu', d.brecha_genero_educacion);
            updateUI('seguro', d.seguro_privado);
            updateUI('brechaseg', d.brecha_genero_seguro);
            updateUI('desocupadas', d.viviendas_desocupadas);
            updateUI('alquiler', d.viviendas_alquiladas_anticretico);
            updateUI('luz', d.viviendas_energiaelectrica_serviciopublico);
            updateUI('agua', d.viviendas_agua_cañería);
            updateUI('cloaca', d.viviendas_desague_alcantarillado);
            updateUI('gas', d.viviendas_combustible_gascañería);
            updateUI('internet', d.viviendas_tics_internet);
            updateUI('dependencia', d.dependencia_economica / 100);
            updateUI('empleados', d.ocupados_empleados);
            updateUI('cuenta', d.ocupados_cuentapropistas);
            updateUI('agri', d.poblacion_agricultura);
            updateUI('com', d.poblacion_comercio);
            updateUI('man', d.poblacion_manufactura);
            updateUI('cons', d.poblacion_construccion);
            updateUI('trans', d.poblacion_transporte);
            updateUI('edu2', d.poblacion_enseñanza);
        }

        function cerrarPanel() {
            document.getElementById('side-panel').classList.remove('active');
            if(layerActiva) layerActiva.setStyle({weight: 0.8, color: '#004494', fillOpacity: 0.2});
        }
    </script>
</body>
</html>