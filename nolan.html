import React, { useMemo, useState, useRef } from "react";
import { jsPDF } from "jspdf";
import html2canvas from "html2canvas";

// === Utilidades ===
const LIKERT = [
  { label: "Muy en desacuerdo", value: -2 },
  { label: "En desacuerdo", value: -1 },
  { label: "Neutral", value: 0 },
  { label: "De acuerdo", value: 1 },
  { label: "Muy de acuerdo", value: 2 },
];

// Cada pregunta: id, texto, pista (humor), pesos {x, y}
// x = econom√≠a (derecha +), y = libertades personales (arriba +)
// value respuesta (-2..+2) * peso
const QUESTIONS = [
  {
    id: "subsidios",
    text:
      "Los subsidios a gasolina y di√©sel deben mantenerse tal cual. (Nada de 'sinceramientos' que hagan llorar al surtidor)",
    hint: "Subvenci√≥n sostenida y precios congelados",
    weight: { x: -1, y: -0.2 }, // mantener subsidio = m√°s Estado ‚Üí x negativo si est√°s de acuerdo
  },
  {
    id: "cambio",
    text:
      "El tipo de cambio debe liberalizarse (flotaci√≥n/dual), aunque duela al principio. (Adi√≥s, 6,96 m√≠tico)",
    hint: "Brecha d√≥lar paralelo vs oficial",
    weight: { x: +1, y: +0.1 },
  },
  {
    id: "litio51",
    text:
      "El Estado debe conservar control mayoritario (51%+) en el litio y priorizar 'socios estrat√©gicos' p√∫blicos. (Selfies con salar opcionales)",
    hint: "Modelo estatal y control de proyectos",
    weight: { x: -1, y: -0.1 },
  },
  {
    id: "litioapertura",
    text:
      "Hay que abrir el litio a licitaciones amplias y competencia internacional, con reglas claras y regal√≠as fijas. (Menos romanticismo, m√°s subastas)",
    hint: "Apertura/competencia",
    weight: { x: +1, y: +0.1 },
  },
  {
    id: "soes",
    text:
      "Las empresas estatales (YPFB, ENDE, BOA, etc.) necesitan m√°s presupuesto y protecci√≥n, no 'restructuraci√≥n' (esa palabra da alergia).",
    hint: "Rol del Estado empresario",
    weight: { x: -1, y: -0.1 },
  },
  {
    id: "bonos",
    text:
      "Los bonos sociales (Juancito Pinto, Renta Dignidad) deben ampliarse universalmente. (Que no quede nadie sin su 'bonus')",
    hint: "Transferencias amplias vs focalizaci√≥n",
    weight: { x: -1, y: -0.1 },
  },
  {
    id: "formalizacion",
    text:
      "Bajar tr√°mites e impuestos a MYPES e informales para formalizar masivamente, aunque el fisco se resienta al inicio. (Tr√°mite killer no more)",
    hint: "Simplificaci√≥n y presi√≥n fiscal",
    weight: { x: +1, y: +0.1 },
  },
  // Libertades personales (eje Y)
  {
    id: "antidrogas",
    text:
      "Bolivia debe permitir cooperaci√≥n internacional robusta contra el narcotr√°fico. (S√≠, incluso si a algunos les incomoda)",
    hint: "Seguridad y crimen organizado",
    weight: { x: +0.1, y: -1 },
  },
  {
    id: "consumoDrogas",
    text:
      "El consumo de drogas debe ser descriminalizado y tratado como salud p√∫blica, no como delito. (Menos c√°rcel, m√°s terapia)",
    hint: "Enfoque salud vs punitivo",
    weight: { x: +0.1, y: +1 },
  },
  {
    id: "chutos",
    text:
      "Regularizar ('amnistiar') los autos chutos porque 'de algo hay que vivir', aunque golpee al mercado formal y la recaudaci√≥n.",
    hint: "Veh√≠culos indocumentados, aduana y propuestas en campa√±a",
    weight: { x: -0.2, y: +1 },
  },
  {
    id: "judicial",
    text:
      "Las altas autoridades judiciales deben elegirse por m√©rito y concursos independientes, no por voto popular. (Menos padrinos, m√°s CV)",
    hint: "Reforma judicial y profesionalizaci√≥n",
    weight: { x: +0.1, y: +1 },
  },
  {
    id: "expresion",
    text:
      "Cualquier ley 'antidesinformaci√≥n' es peligrosa: prefiero libertad de expresi√≥n incluso para memes horribles (s√≠, esos).",
    hint: "Regulaci√≥n de contenidos",
    weight: { x: +0.1, y: +1 },
  },
  {
    id: "protesta",
    text:
      "Los bloqueos y marchas deben limitarse estrictamente; el orden ante todo (el meme despu√©s).",
    hint: "Protesta social vs orden p√∫blico",
    weight: { x: +0.1, y: -1 },
  },
  {
    id: "autonomia",
    text:
      "Profundizar autonom√≠as departamentales y municipales (m√°s competencias y menos peregrinaje a La Paz).",
    hint: "Redistribuci√≥n de esca√±os y descentralizaci√≥n",
    weight: { x: +0.2, y: +1 }, // leve impacto econ√≥mico (competencia fiscal)
  },
  {
    id: "derechos",
    text:
      "Ampliar derechos civiles (p.ej., matrimonio igualitario, salud sexual y reproductiva) es prioridad. (El Estado no es tu tutor)",
    hint: "Agenda de libertades",
    weight: { x: +0.05, y: +1 },
  },
];

function computeScores(answers) {
  // Suma ponderada
  let sx = 0, sy = 0, wx = 0, wy = 0;
  QUESTIONS.forEach((q) => {
    const v = answers[q.id];
    if (typeof v !== "number") return;
    if (q.weight.x !== 0) {
      sx += v * q.weight.x;
      wx += Math.abs(q.weight.x);
    }
    if (q.weight.y !== 0) {
      sy += v * q.weight.y;
      wy += Math.abs(q.weight.y);
    }
  });
  // Normaliza a -100..100 por eje
  const nx = wx ? (sx / (2 * wx)) * 100 : 0; // como max |v|=2
  const ny = wy ? (sy / (2 * wy)) * 100 : 0;
  return { nx: Math.max(-100, Math.min(100, nx)), ny: Math.max(-100, Math.min(100, ny)) };
}

function quadrantLabel(nx, ny) {
  if (ny >= 0 && nx >= 0) return "Libertario";
  if (ny >= 0 && nx < 0) return "Progresista";
  if (ny < 0 && nx < 0) return "Estatista/Autoritario";
  return "Conservador";
}

// ===== Avatares por cuadrante (puedes cambiar las URLs) =====
// ===== Avatares por cuadrante (puedes cambiar las URLs) =====
const AVATARS: Record<string, string> = {
  progresista: "https://i.imgur.com/hO8mYTZ.png",   // Wokes
  libertario:  "https://i.imgur.com/ohgxXMr.png",   // Enr√≠quez
  conservador: "https://i.imgur.com/3T5vL8F.png",   // Pinto
  estatista:   "https://i.imgur.com/YNAUHio.png"    // Alonzo
};

function quadrantKey(nx: number, ny: number): string {
  if (ny >= 0 && nx >= 0) return "libertario";
  if (ny >= 0 && nx < 0) return "progresista";
  if (ny < 0 && nx < 0) return "estatista";
  return "conservador";
}

function NolanChart({ nx, ny }) {
  // lienzo 360x360, centro 180,180
  const size = 360;
  const center = size / 2;
  const scale = (size * 0.4) / 100; // 40% del tama√±o para 100 unidades
  const px = center + nx * scale;
  const py = center - ny * scale;
  const key = quadrantKey(nx, ny);
  const avatar = AVATARS[key];

  return (
    <svg viewBox={`0 0 ${size} ${size}`} className="w-full h-auto">
      {/* Fondo */}
      <rect x="0" y="0" width={size} height={size} className="fill-white" />
      {/* Cuadr√≠cula ligera */}
      {[...Array(9)].map((_, i) => (
        <g key={i}>
          <line x1={20} x2={size - 20} y1={20 + i * 40} y2={20 + i * 40} className="stroke-slate-200" />
          <line x1={20 + i * 40} x2={20 + i * 40} y1={20} y2={size - 20} className="stroke-slate-200" />
        </g>
      ))}
      {/* Ejes */}
      <line x1={20} x2={size - 20} y1={center} y2={center} className="stroke-slate-500" />
      <line x1={center} x2={center} y1={20} y2={size - 20} className="stroke-slate-500" />
      {/* Etiquetas */}
      <text x={size - 8} y={center - 6} textAnchor="end" className="fill-slate-700 text-[10px]">Econom√≠a ‚ûú</text>
      <text x={center + 6} y={12} className="fill-slate-700 text-[10px]">Libertades ‚Üë</text>
      {/* Cuadrantes + sub-etiquetas humor√≠sticas (seg√∫n tu pedido) */}
      <text x={center + 70} y={center - 70} className="fill-emerald-600 text-[12px]">Libertario</text>
      <text x={center + 70} y={center - 56} className="fill-slate-500 text-[9px]">Enr√≠quez (¬°viva Milei, viva Vox!)</text>

      <text x={center - 150} y={center - 70} className="fill-indigo-600 text-[12px]">Progresista</text>
      <text x={center - 150} y={center - 56} className="fill-slate-500 text-[9px]">Flores / Carlitos (wokes)</text>

      <text x={center - 150} y={center + 90} className="fill-rose-600 text-[12px]">Estatista/Autoritario</text>
      <text x={center - 150} y={center + 104} className="fill-slate-500 text-[9px]">Alonzo / Tankie</text>

      <text x={center + 70} y={center + 90} className="fill-amber-600 text-[12px]">Conservador</text>
      <text x={center + 70} y={center + 104} className="fill-slate-500 text-[9px]">Pinto</text>

      {/* Avatar o punto */}
      {avatar ? (
        <>
          <image href={avatar} x={px - 18} y={py - 18} width={36} height={36} crossOrigin="anonymous" />
          <circle cx={px} cy={py} r={20} className="fill-transparent stroke-sky-600" />
        </>
      ) : (
        <>
          <circle cx={px} cy={py} r={6} className="fill-sky-600 stroke-white" />
          <circle cx={px} cy={py} r={10} className="fill-transparent stroke-sky-600" />
        </>
      )}
    </svg>
  );
}

export default function App() {
  const [answers, setAnswers] = useState<Record<string, number>>({});
  const [name, setName] = useState("");
  const [step, setStep] = useState(0); // √≠ndice de pregunta actual
  const resultRef = useRef<HTMLDivElement | null>(null);

  const { nx, ny } = useMemo(() => computeScores(answers), [answers]);
  const label = quadrantLabel(nx, ny);

  const allAnswered = useMemo(
    () => QUESTIONS.every((q) => typeof answers[q.id] === "number"),
    [answers]
  );

  const reset = () => {
    setAnswers({});
    setStep(0);
  };

  const handleSelect = (qid: string, val: number) => {
    setAnswers((a) => ({ ...a, [qid]: val }));
    if (step < QUESTIONS.length - 1) {
      // peque√±o delay para que el usuario vea el check
      setTimeout(() => setStep((s) => s + 1), 120);
    }
  };

  const exportPDF = async () => {
    if (!resultRef.current) return;
    const el = resultRef.current as HTMLDivElement;
    const canvas = await html2canvas(el, { scale: 2, backgroundColor: "#ffffff", useCORS: true });
    const img = canvas.toDataURL("image/png");
    const pdf = new jsPDF({ orientation: "portrait", unit: "pt", format: "a4" });
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();

    // Encabezado
    pdf.setFontSize(16);
    pdf.text("Nolan Bolivia ‚Äî Resultado", 40, 40);
    pdf.setFontSize(10);
    pdf.text(`Nombre: ${name || "(an√≥nimo)"}`, 40, 58);
    pdf.text(`Coordenadas: X ${nx.toFixed(1)}, Y ${ny.toFixed(1)} ‚Äî ${label}`, 40, 72);

    // Gr√°fico / tarjeta
    const imgWidth = pageWidth - 80;
    const ratio = canvas.height / canvas.width;
    const imgHeight = imgWidth * ratio;
    pdf.addImage(img, "PNG", 40, 90, imgWidth, Math.min(imgHeight, pageHeight - 130));

    // Pie
    pdf.setFontSize(8);
    pdf.text("Preguntas contextualizadas a Bolivia (2024‚Äì2025). Humor responsable. Las sub-etiquetas de cuadrantes son sat√≠ricas a pedido del usuario.", 40, pageHeight - 24);

    pdf.save(`Nolan_Bolivia_${Date.now()}.pdf`);
  };

  const total = QUESTIONS.length;
  const q = QUESTIONS[step];

  return (
    <div className="min-h-screen bg-slate-50 text-slate-800">
      <div className="max-w-5xl mx-auto p-6 md:p-10">
        <header className="mb-6">
          <h1 className="text-3xl md:text-4xl font-bold tracking-tight">Nolan Bolivia üß≠</h1>
          <p className="text-slate-600 mt-2 max-w-3xl">
            Responde con honestidad brutal (y una pizca de sarcasmo). Al final ver√°s tu ubicaci√≥n en el diagrama y podr√°s descargar un PDF.
          </p>
          <div className="mt-4 flex flex-wrap gap-3 items-center">
            <label className="text-sm">Tu nombre (opcional):</label>
            <input
              value={name}
              onChange={(e) => setName(e.target.value)}
              placeholder="Ej. Daniela, Juan, An√≥nimo"
              className="px-3 py-2 rounded-xl border border-slate-300 bg-white"
            />
          </div>
        </header>

        <main className="grid md:grid-cols-2 gap-8 items-start">
          {/* Wizard de preguntas (una por vez) */}
          <section>
            <div className="mb-3 text-xs text-slate-600">Pregunta {step + 1} / {total}</div>
            <div className="h-2 w-full bg-slate-200/60 rounded-full overflow-hidden mb-4">
              <div
                className="h-full bg-sky-600 transition-all"
                style={{ width: `${((step + (answers[q?.id] !== undefined ? 1 : 0)) / total) * 100}%` }}
              />
            </div>

            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 md:p-5">
              <h3 className="font-semibold mb-1">{q.text}</h3>
              {q.hint && <p className="text-xs text-slate-500 mb-3">{q.hint}</p>}

              <div className="flex flex-col sm:flex-row sm:flex-wrap sm:items-center gap-2 sm:gap-2">
                {LIKERT.map((opt) => (
                  <label key={opt.value} className="flex items-center gap-1 text-xs cursor-pointer select-none px-2 py-1 rounded-md border border-slate-200">
                    <input className="w-3 h-3" type="radio"
                      name={q.id}
                      value={opt.value}
                      checked={answers[q.id] === opt.value}
                      onChange={() => handleSelect(q.id, opt.value)}
                    />
                    <span className="leading-tight">{opt.label}</span>
                  </label>
                ))}
              </div>

              <div className="mt-5 flex gap-3">
                <button
                  onClick={() => setStep((s) => Math.max(0, s - 1))}
                  className="px-4 py-2 rounded-xl bg-white border border-slate-300 hover:bg-slate-100 disabled:opacity-50"
                  disabled={step === 0}
                >
                  Anterior
                </button>
                <button
                  onClick={() => setStep((s) => Math.min(total - 1, s + 1))}
                  className="px-4 py-2 rounded-xl bg-white border border-slate-300 hover:bg-slate-100"
                >
                  Siguiente
                </button>
                <button
                  onClick={reset}
                  className="px-4 py-2 rounded-xl bg-white border border-slate-300 hover:bg-slate-100"
                >
                  Reiniciar
                </button>
              </div>
            </div>

            <div className="mt-6">
              <button
                onClick={exportPDF}
                disabled={!allAnswered}
                className={`px-4 py-2 rounded-xl text-white ${allAnswered ? "bg-sky-600 hover:bg-sky-700" : "bg-slate-400 cursor-not-allowed"}`}
              >
                Descargar PDF
              </button>
            </div>
          </section>

          {/* Resultado */}
          <section ref={resultRef} className="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 md:p-6">
            <div className="flex items-baseline justify-between mb-3">
              <h2 className="font-semibold">Tu ubicaci√≥n</h2>
              <div className="text-xs text-slate-500">X {nx.toFixed(1)} ¬∑ Y {ny.toFixed(1)}</div>
            </div>
            <NolanChart nx={nx} ny={ny} />
            <div className="mt-3 text-center">
              <div className="inline-flex items-center gap-2 rounded-full px-3 py-1 bg-slate-100 text-slate-700">
                <span className="text-sm">Resultado:</span>
                <strong className="text-sm">{label}</strong>
              </div>
            </div>
            <p className="text-xs text-slate-500 mt-4">
              Nota: eje X = libertad econ√≥mica (mercado ‚áÑ Estado). Eje Y = libertades personales (autonom√≠a ‚áÑ orden). Es un mapa, no un destino.
            </p>
          </section>
        </main>

        <footer className="mt-10 text-xs text-slate-500">
          Hecho con React + Tailwind. Preguntas adaptadas a Bolivia 2024‚Äì2025. Humor responsable. Las sub-etiquetas con nombres son sat√≠ricas y fueron solicitadas por el usuario.
        </footer>
      </div>
    </div>
  );
}

</html>
