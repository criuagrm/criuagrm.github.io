<!doctype html>
<html lang="es" class="scroll-smooth">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>EDU-TERRITORIAL: Visor de Vulnerabilidad — CIRCPyCS</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            cordis: { blue: '#004494', dark: '#0f2c52', accent: '#d97706' }
          },
          fontFamily: { sans: ['Inter', 'sans-serif'], serif: ['Merriweather', 'serif'] }
        }
      }
    }
  </script>
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    body { background-color: #f8fafc; color: #334155; }
    h1, h2, h3 { color: #0f2c52; letter-spacing: -0.025em; }
    .modern-card { background: white; border-radius: 1rem; border: 1px solid rgba(226, 232, 240, 0.8); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02); }
    
    /* MODAL DEL MAPA */
    #visor-modal { position: fixed; inset: 0; z-index: 9999; background: white; display: flex; flex-direction: column; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
    #visor-modal.active { opacity: 1; pointer-events: auto; }
    #visor-header { background: #0f2c52; color: white; padding: 12px 24px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 1000; }
    #mapa-contenedor { flex-grow: 1; position: relative; width: 100%; height: 100%; }
    #mapa-edu { width: 100%; height: 100%; background: #e2e8f0; }

    /* PANEL DE CONTROL FLOTANTE (Optimizado para Indicadores) */
    .map-control-panel { position: absolute; top: 20px; right: 20px; z-index: 1000; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); width: 320px; border: 2px solid #f1f5f9; }
    .layer-selector { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 12px; font-weight: 700; color: #0f2c52; outline: none; cursor: pointer; background: #f8fafc; margin-bottom: 15px; }
    
    /* LEYENDA */
    .legend-scale { display: flex; height: 14px; border-radius: 6px; overflow: hidden; margin-top: 15px; border: 1px solid #e2e8f0; }
    .legend-scale div { flex: 1; }
    .legend-labels { display: flex; justify-content: space-between; font-size: 10px; color: #64748b; font-weight: 700; margin-top: 6px; text-transform: uppercase;}
    
    /* RESULTADOS DEL CLIC */
    .data-result { background: #fffbeb; border: 1px solid #fde68a; padding: 15px; border-radius: 8px; margin-top: 20px; display: none; }
    .data-result h4 { margin: 0 0 8px 0; font-size: 10px; font-weight: 800; text-transform: uppercase; color: #b45309; letter-spacing: 0.5px;}
    .data-result .main-val { font-size: 28px; font-weight: 800; color: #d97706; line-height: 1; margin-bottom: 5px; }
    .data-result .sub-val { font-size: 12px; color: #78350f; font-weight: 500;}
    .data-result .extra-val { font-size: 10px; color: #92400e; margin-top: 8px; border-top: 1px solid #fcd34d; padding-top: 8px;}
  </style>
</head>
<body class="font-sans flex flex-col min-h-screen">

  <div id="visor-modal">
    <div id="visor-header">
      <div class="flex items-center gap-3">
        <i class="fa-solid fa-microscope text-cordis-accent text-2xl"></i>
        <div>
          <h2 class="text-white text-sm font-bold m-0">Visor Analítico: EDU-TERRITORIAL</h2>
          <p class="text-[10px] text-slate-400 m-0 uppercase tracking-widest">Indicadores Estratégicos a nivel Manzano</p>
        </div>
      </div>
      <button onclick="cerrarVisor()" class="bg-white/10 hover:bg-red-500 text-white px-4 py-2 rounded-lg text-xs font-bold transition flex items-center gap-2">
        <i class="fa-solid fa-xmark"></i> Cerrar
      </button>
    </div>
    
    <div id="mapa-contenedor">
      <div id="mapa-edu"></div>
      
      <div class="map-control-panel">
        <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2"><i class="fa-solid fa-filter text-cordis-blue"></i> Seleccione Indicador de Estudio</h3>
        
        <select id="layer-selector" class="layer-selector" onchange="cambiarCapa()">
          <option value="porcentaje_menor20">1. Presión Demográfica Escolar</option>
          <option value="educacion_superior">2. Capital Cultural del Entorno</option>
          <option value="viviendas_tics_internet">3. Índice de Conectividad Digital</option>
          <option value="dependencia_economica">4. Riesgo Socioeconómico (Dependencia)</option>
          <option value="poblacion_migrante">5. Nivel de Desarraigo (Migración)</option>
        </select>

        <div id="leyenda-container">
          <h4 class="text-xs font-bold text-slate-700 mb-1 leading-tight" id="leyenda-titulo">Interpretación</h4>
          <p class="text-[10px] text-slate-500 mb-2" id="leyenda-desc">Concentración de población menor de 20 años.</p>
          
          <div class="legend-scale" id="leyenda-colores"></div>
          <div class="legend-labels">
            <span id="leyenda-min">Bajo</span>
            <span id="leyenda-max">Alto</span>
          </div>
        </div>

        <div id="panel-resultados" class="data-result">
          <h4>Radiografía Específica</h4>
          <div class="main-val" id="res-principal">--</div>
          <div class="sub-val" id="res-secundario">--</div>
          <div class="extra-val" id="res-extra">Población total del manzano: 0</div>
        </div>
        
        <div id="mapa-loading" class="mt-4 text-center text-xs text-amber-600 font-bold hidden bg-amber-50 p-2 rounded">
          <i class="fa-solid fa-circle-notch fa-spin"></i> Procesando 61,000 polígonos...
        </div>
      </div>
    </div>
  </div>
  <div class="bg-cordis-dark text-white/90 py-1.5 text-[10px] md:text-xs text-center font-bold tracking-widest uppercase shadow-sm">
    CIRCPyCS — Universidad Autónoma Gabriel René Moreno
  </div>
  <header class="bg-white/90 backdrop-blur-md border-b border-gray-200 sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="https://i.imgur.com/ldeXZmG.png" alt="Logo" class="h-10 w-auto" />
        <div class="h-8 w-px bg-gray-200 mx-1"></div>
        <div class="leading-tight">
          <span class="block font-bold text-cordis-blue text-sm tracking-tight">CIRCPyCS</span>
          <span class="block text-[10px] text-gray-500 font-medium uppercase tracking-wider">Investigación</span>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-4xl mx-auto px-4 py-12 text-center">
    <span class="bg-amber-100 text-amber-700 text-[10px] font-bold px-3 py-1 rounded-full uppercase tracking-widest mb-4 inline-block">Módulo Geoespacial</span>
    <h1 class="text-4xl md:text-5xl font-extrabold text-cordis-dark mb-6 tracking-tight">
      Modelo Educativo Territorializado
    </h1>
    <p class="text-lg text-slate-500 mb-10 leading-relaxed">
      Herramienta analítica para identificar áreas críticas de intervención pedagógica cruzando vulnerabilidad socioeconómica, brecha digital y capital cultural.
    </p>
    
    <div class="bg-white p-8 rounded-2xl shadow-lg border border-slate-100 max-w-2xl mx-auto">
      <i class="fa-solid fa-map-location-dot text-6xl text-cordis-accent mb-6"></i>
      <h3 class="text-xl font-bold text-slate-800 mb-2">Explorador de Datos Censales 2024</h3>
      <p class="text-sm text-slate-500 mb-8">El visor carga los indicadores estratégicos calculados para cada manzano del departamento, permitiendo una planificación educativa basada en evidencia empírica.</p>
      
      <button onclick="abrirVisor()" class="w-full py-4 bg-cordis-blue text-white text-sm font-bold rounded-xl hover:bg-[#003377] transition shadow-md flex items-center justify-center gap-3 transform hover:-translate-y-1">
        <i class="fa-solid fa-satellite-dish"></i> Iniciar Visor Analítico
      </button>
    </div>
  </main>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // ==========================================
    // CONFIGURACIÓN DE LOS INDICADORES DEL PROYECTO
    // ==========================================
    const configIndicadores = {
      'porcentaje_menor20': { 
        titulo: 'Presión Demográfica Escolar', 
        desc: 'Identifica zonas con alta concentración de niños y adolescentes (menores de 20 años).',
        maximo: 0.50, // 50% es el tope visual
        formato: 'porcentaje' 
      },
      'educacion_superior': { 
        titulo: 'Capital Cultural del Entorno', 
        desc: 'Porcentaje de adultos con formación universitaria. Áreas claras indican vulnerabilidad académica.',
        maximo: 0.40, 
        formato: 'porcentaje' 
      },
      'viviendas_tics_internet': { 
        titulo: 'Índice de Conectividad Digital', 
        desc: 'Hogares con acceso a internet. Vital para planificar educación híbrida o a distancia.',
        maximo: 0.90, 
        formato: 'porcentaje' 
      },
      'dependencia_economica': { 
        titulo: 'Riesgo Socioeconómico', 
        desc: 'Carga económica sobre la población ocupada. Índices altos correlacionan con trabajo infantil y abandono escolar.',
        maximo: 1.5, // 150%
        formato: 'ratio' 
      },
      'poblacion_migrante': { 
        titulo: 'Nivel de Desarraigo (Migración)', 
        desc: 'Porcentaje de población no nacida en el municipio. Clave para enfoques de interculturalidad.',
        maximo: 0.40, 
        formato: 'porcentaje' 
      }
    };

    // Paleta de colores cálida (Amarillo a Terracota)
    const paleta = ['#fef3c7', '#fde68a', '#fbbf24', '#f59e0b', '#d97706', '#92400e'];

    let map, geojsonLayer, mapaDatos = null, traductor = {};
    let indicadorActual = 'porcentaje_menor20';

    function abrirVisor() {
      document.getElementById('visor-modal').classList.add('active');
      document.body.style.overflow = 'hidden';
      if (!map) initMap();
      else setTimeout(() => map.invalidateSize(), 100);
    }

    function cerrarVisor() {
      document.getElementById('visor-modal').classList.remove('active');
      document.body.style.overflow = '';
    }

    function initMap() {
      map = L.map('mapa-edu', { zoomControl: false }).setView([-17.7833, -63.1821], 12);
      L.control.zoom({ position: 'bottomright' }).addTo(map);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

      document.getElementById('mapa-loading').classList.remove('hidden');

      fetch('campos.json')
        .then(res => res.json())
        .then(data => {
            for (let k in data) { traductor[data[k]] = k; }
            cargarPoligonos();
        });
    }

    function cargarPoligonos() {
      fetch('manzanos.geojson')
        .then(res => res.json())
        .then(data => {
            mapaDatos = data;
            document.getElementById('mapa-loading').classList.add('hidden');
            renderizarCapa();
            actualizarLeyendaUI();
        });
    }

    // ALGORITMO DE MAPA DE CALOR INTELIGENTE
    function getColor(valor) {
        if(valor === undefined || valor === null) return '#e2e8f0'; // Sin datos
        
        let cfg = configIndicadores[indicadorActual];
        
        // Calculamos qué tan cerca está del valor "máximo" esperado
        let ratio = valor / cfg.maximo;
        if(ratio > 1) ratio = 1;
        if(ratio < 0) ratio = 0;
        
        // Asignamos uno de los 6 colores de la paleta
        let index = Math.floor(ratio * 5.99);
        return paleta[index];
    }

    function estiloPoligono(feature) {
        let d = {};
        for (let k in feature.properties) { if(traductor[k]) d[traductor[k]] = feature.properties[k]; }
        
        // Para dependencia económica, el dato viene como entero (ej. 150 = 150%), lo pasamos a decimal
        let valorCapa = d[indicadorActual];
        if (indicadorActual === 'dependencia_economica') valorCapa = valorCapa / 100;

        return {
            fillColor: getColor(valorCapa),
            weight: 0.5,
            opacity: 1,
            color: 'white',
            fillOpacity: 0.8
        };
    }

    function renderizarCapa() {
        if (geojsonLayer) map.removeLayer(geojsonLayer);

        geojsonLayer = L.geoJSON(mapaDatos, {
            style: estiloPoligono,
            onEachFeature: function(feature, layer) {
                layer.on({
                    mouseover: function(e) { e.target.setStyle({ weight: 2, color: '#0f2c52', fillOpacity: 1 }); e.target.bringToFront(); },
                    mouseout: function(e) { geojsonLayer.resetStyle(e.target); },
                    click: function(e) { mostrarDatosClick(feature.properties); }
                });
            }
        }).addTo(map);
    }

    function cambiarCapa() {
        indicadorActual = document.getElementById('layer-selector').value;
        renderizarCapa();
        actualizarLeyendaUI();
        document.getElementById('panel-resultados').style.display = 'none';
    }

    function actualizarLeyendaUI() {
        let cfg = configIndicadores[indicadorActual];
        document.getElementById('leyenda-titulo').innerText = cfg.titulo;
        document.getElementById('leyenda-desc').innerText = cfg.desc;
        
        let divColores = document.getElementById('leyenda-colores');
        divColores.innerHTML = '';
        paleta.forEach(color => { divColores.innerHTML += `<div style="background: ${color}"></div>`; });

        // Actualiza el texto del límite superior
        let maxDisplay = cfg.formato === 'porcentaje' ? Math.round(cfg.maximo * 100) + '%' : Math.round(cfg.maximo * 100) + '%';
        document.getElementById('leyenda-max').innerText = "> " + maxDisplay;
    }

    function mostrarDatosClick(p) {
        let d = {};
        for (let k in p) { if(traductor[k]) d[traductor[k]] = p[k]; }

        let cfg = configIndicadores[indicadorActual];
        let valorBruto = d[indicadorActual] || 0;
        
        let displayVal = "";
        if(indicadorActual === 'dependencia_economica') {
            displayVal = Math.round(valorBruto) + "%";
        } else {
            displayVal = Math.round(valorBruto * 100) + "%";
        }

        document.getElementById('panel-resultados').style.display = 'block';
        document.getElementById('res-principal').innerText = displayVal;
        document.getElementById('res-secundario').innerText = "Nivel de " + cfg.titulo;
        document.getElementById('res-extra').innerText = "Habitantes en la cuadra: " + Math.round(d.personas || 0);
    }
  </script>
</body>
</html>
