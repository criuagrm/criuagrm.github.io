<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Motor SIG Educativo ‚Äî CIRCPyCS</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; background: #0f172a; overflow: hidden; }
        #mapa { width: 100vw; height: 100vh; z-index: 1; }
        
        /* Tema UI Data Science (Glassmorphism Oscuro) */
        .glass-panel {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #f8fafc;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        /* HEADER FLOTANTE */
        #ui-header {
            position: absolute; top: 20px; left: 20px; z-index: 1000;
            padding: 12px 20px; border-radius: 12px;
            display: flex; align-items: center; gap: 15px;
        }
        #ui-header img { height: 40px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); }
        
        /* CONTROL DE CAPAS Y LEYENDA */
        #ui-controls {
            position: absolute; top: 20px; right: 20px; z-index: 1000;
            width: 340px; padding: 20px; border-radius: 16px;
        }
        select.ds-select {
            width: 100%; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2);
            color: white; font-family: 'Inter'; font-size: 13px; font-weight: 600; border-radius: 8px;
            outline: none; margin-bottom: 15px; cursor: pointer;
        }
        select.ds-select option { background: #0f172a; color: white; }

        /* LEYENDA T√âCNICA */
        .legend-bar { display: flex; height: 10px; border-radius: 4px; overflow: hidden; margin: 15px 0 5px 0; }
        .legend-bar div { flex: 1; }
        .legend-labels { display: flex; justify-content: space-between; font-size: 10px; color: #94a3b8; font-weight: 600; text-transform: uppercase;}

        /* EXPEDIENTE ANAL√çTICO (PANEL IZQUIERDO) */
        #ui-analytics {
            position: absolute; top: 90px; left: 20px; z-index: 1000;
            width: 360px; max-height: calc(100vh - 120px); overflow-y: auto;
            padding: 24px; border-radius: 16px; transform: translateX(-120%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #ui-analytics.active { transform: translateX(0); }
        
        /* Barras de datos avanzadas */
        .metric-group { margin-bottom: 16px; }
        .metric-header { display: flex; justify-content: space-between; font-size: 11px; color: #cbd5e1; margin-bottom: 6px; font-weight: 500; text-transform: uppercase;}
        .metric-val { font-weight: 700; color: white; }
        .metric-track { width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; }
        .metric-fill { height: 100%; border-radius: 3px; transition: width 0.8s ease; }

        .score-box { text-align: center; padding: 20px; background: rgba(0,0,0,0.3); border-radius: 12px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.05); }
        .score-value { font-size: 42px; font-weight: 800; line-height: 1; background: linear-gradient(to right, #fbbf24, #ef4444); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        /* SCROLLBAR CUSTOM */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }

        /* Loader */
        .ds-loader { padding: 10px; background: rgba(217, 119, 6, 0.2); color: #fbbf24; border: 1px solid rgba(217, 119, 6, 0.5); text-align: center; font-size: 11px; font-weight: bold; border-radius: 8px; margin-top: 15px;}
    </style>
</head>
<body>

    <div id="ui-header" class="glass-panel">
        <img src="https://i.imgur.com/ldeXZmG.png" alt="CIRCPyCS">
        <div>
            <h1 class="text-[13px] font-bold m-0 tracking-wide text-white">EDU-TERRITORIAL SIG</h1>
            <p class="text-[9px] text-slate-400 m-0 uppercase tracking-widest font-semibold">Motor de Ciencia de Datos</p>
        </div>
    </div>

    <div id="ui-controls" class="glass-panel">
        <h2 class="text-xs font-bold text-slate-300 uppercase tracking-widest mb-3 flex items-center gap-2">
            <i class="fa-solid fa-layer-group text-blue-400"></i> Modelo de Procesamiento
        </h2>
        
        <select id="layer-selector" class="ds-select" onchange="cambiarCapa()">
            <option value="irem">üî• √çndice de Riesgo Educativo Multidimensional (IREM)</option>
            <option value="densidad_joven">üë• Presi√≥n Demogr√°fica Escolar (Hab/Ha)</option>
            <option value="capital_cultural">üéì Capital Cultural del Hogar</option>
            <option value="aislamiento_tec">üì° Aislamiento Tecnol√≥gico</option>
            <option value="brecha_genero_edu">‚öñÔ∏è Brecha de G√©nero Educativa</option>
        </select>

        <div class="pt-3 border-t border-slate-700">
            <h3 class="text-sm font-bold text-white mb-1" id="leg-title">IREM</h3>
            <p class="text-[10px] text-slate-400 leading-relaxed mb-0" id="leg-desc">Algoritmo compuesto que eval√∫a la vulnerabilidad estructural.</p>
            
            <div class="legend-bar" id="leg-colors"></div>
            <div class="legend-labels">
                <span id="leg-min">Bajo Riesgo</span>
                <span id="leg-max">Alto Riesgo</span>
            </div>
        </div>

        <div id="loader" class="ds-loader hidden"><i class="fa-solid fa-gear fa-spin"></i> Ejecutando algoritmos espaciales...</div>
    </div>

    <div id="ui-analytics" class="glass-panel">
        <div class="flex justify-between items-start mb-4 border-b border-slate-700 pb-3">
            <h2 class="text-sm font-bold text-blue-400 uppercase tracking-widest"><i class="fa-solid fa-microscope"></i> Radiograf√≠a del Manzano</h2>
            <button onclick="cerrarPanel()" class="text-slate-400 hover:text-white transition"><i class="fa-solid fa-xmark text-lg"></i></button>
        </div>

        <div class="score-box">
            <div class="text-[10px] text-slate-400 uppercase tracking-widest font-bold mb-1">Score IREM Obtenido</div>
            <div class="score-value" id="res-score">00.0</div>
            <div class="text-xs text-slate-300 mt-1" id="res-score-label">Riesgo Cr√≠tico</div>
        </div>

        <h3 class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-3">Vectores Desagregados</h3>

        <div class="metric-group">
            <div class="metric-header"><span>Presi√≥n Demogr√°fica (<20)</span> <span class="metric-val text-emerald-400" id="m-jovenes">0%</span></div>
            <div class="metric-track"><div class="metric-fill bg-emerald-500" id="b-jovenes"></div></div>
        </div>

        <div class="metric-group">
            <div class="metric-header"><span>Capital Cultural (Ed. Sup)</span> <span class="metric-val text-blue-400" id="m-edu">0%</span></div>
            <div class="metric-track"><div class="metric-fill bg-blue-500" id="b-edu"></div></div>
        </div>

        <div class="metric-group">
            <div class="metric-header"><span>Aislamiento Digital</span> <span class="metric-val text-rose-400" id="m-net">0%</span></div>
            <div class="metric-track"><div class="metric-fill bg-rose-500" id="b-net"></div></div>
        </div>

        <div class="metric-group">
            <div class="metric-header"><span>Estr√©s Econ√≥mico</span> <span class="metric-val text-amber-400" id="m-dep">0%</span></div>
            <div class="metric-track"><div class="metric-fill bg-amber-500" id="b-dep"></div></div>
        </div>

        <div class="mt-6 pt-4 border-t border-slate-700 grid grid-cols-2 gap-4">
            <div>
                <div class="text-[9px] text-slate-400 uppercase">Pob. Total</div>
                <div class="text-sm font-bold text-white" id="m-pob">0</div>
            </div>
            <div>
                <div class="text-[9px] text-slate-400 uppercase">Desarraigo (Mig.)</div>
                <div class="text-sm font-bold text-white" id="m-mig">0%</div>
            </div>
        </div>
    </div>

    <div id="mapa"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ==========================================
        // ALGORITMOS DE DATA SCIENCE (M√âTRICAS COMPUESTAS)
        // ==========================================
        
        // Paletas de color optimizadas para visualizaci√≥n de datos (Hex)
        const paletas = {
            riesgo: ['#fee5d9', '#fcae91', '#fb6a4a', '#de2d26', '#a50f15'], // YlOrRd
            educacion: ['#eff3ff', '#bdd7e7', '#6baed6', '#3182bd', '#08519c'], // Blues
            demografia: ['#edf8e9', '#bae4b3', '#74c476', '#31a354', '#006d2c'] // Greens
        };

        const algoritmos = {
            'irem': {
                titulo: '√çndice de Riesgo Educativo Multidimensional',
                desc: 'Combina: Aislamiento Digital + Baja Educaci√≥n Adulta + Estr√©s Econ√≥mico.',
                maximo: 100, paleta: paletas.riesgo, formato: 'pts',
                calc: (d) => {
                    // C√°lculo Senior: Normalizaci√≥n y Promedio Ponderado
                    let falta_net = 1 - (d.viviendas_tics_internet || 0);
                    let falta_edu = 1 - (d.educacion_superior || 0);
                    let dep = (d.dependencia_economica || 0) / 100;
                    let dep_norm = Math.min(dep / 1.5, 1); // Tope estad√≠stico
                    return ((falta_net + falta_edu + dep_norm) / 3) * 100;
                }
            },
            'densidad_joven': {
                titulo: 'Presi√≥n Demogr√°fica Escolar',
                desc: 'Cantidad absoluta estimada de menores de 20 a√±os por hect√°rea.',
                maximo: 80, paleta: paletas.demografia, formato: 'hab/ha',
                calc: (d) => {
                    return (d.personas_por_hectarea || 0) * (d.porcentaje_menor20 || 0);
                }
            },
            'capital_cultural': {
                titulo: 'Capital Cultural del Hogar',
                desc: 'Concentraci√≥n de adultos con estudios universitarios.',
                maximo: 0.40, paleta: paletas.educacion, formato: '%',
                calc: (d) => d.educacion_superior || 0
            },
            'aislamiento_tec': {
                titulo: 'Aislamiento Tecnol√≥gico',
                desc: 'Porcentaje de viviendas SIN acceso a internet.',
                maximo: 1.0, paleta: paletas.riesgo, formato: '%',
                calc: (d) => 1 - (d.viviendas_tics_internet || 0)
            },
            'brecha_genero_edu': {
                titulo: 'Brecha de G√©nero Educativa',
                desc: 'Desventaja educativa de la mujer respecto al hombre.',
                maximo: 0.15, paleta: paletas.riesgo, formato: '%',
                calc: (d) => Math.max(d.brecha_genero_educacion || 0, 0)
            }
        };

        let map, geojsonLayer, mapaDatos = null, traductor = {};
        let algoritmoActual = 'irem';

        // Inicializaci√≥n
        const mapaOscuro = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: 'CIRCPyCS DS' });
        
        map = L.map('mapa', { zoomControl: false, layers: [mapaOscuro] }).setView([-17.7833, -63.1821], 12);
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        document.getElementById('loader').classList.remove('hidden');

        // Seguridad Chrome Localhost
        fetch('campos.json')
            .then(res => { if(!res.ok) throw new Error(); return res.json(); })
            .then(data => {
                for (let k in data) traductor[data[k]] = k;
                fetch('manzanos.geojson')
                    .then(r => r.json())
                    .then(geo => {
                        mapaDatos = geo;
                        document.getElementById('loader').classList.add('hidden');
                        renderizarCapa();
                        actualizarLeyenda();
                    });
            })
            .catch(() => alert("‚ö†Ô∏è Por seguridad, ejecuta el servidor Python (python -m http.server 8000) en esta carpeta."));

        // Funci√≥n de color din√°mica
        function getColor(valor) {
            if (valor === undefined || isNaN(valor)) return 'transparent';
            let cfg = algoritmos[algoritmoActual];
            let ratio = valor / cfg.maximo;
            ratio = Math.max(0, Math.min(1, ratio));
            let index = Math.floor(ratio * (cfg.paleta.length - 0.01));
            return cfg.paleta[index];
        }

        function estiloPoligono(feature) {
            let d = {};
            for (let k in feature.properties) { if(traductor[k]) d[traductor[k]] = feature.properties[k]; }
            
            // EJECUCI√ìN DEL ALGORITMO SELECCIONADO EN TIEMPO REAL
            let valorCalculado = algoritmos[algoritmoActual].calc(d);

            return {
                fillColor: getColor(valorCalculado),
                weight: 0.5, opacity: 1, color: '#1e293b', fillOpacity: 0.85
            };
        }

        function renderizarCapa() {
            if (geojsonLayer) map.removeLayer(geojsonLayer);
            geojsonLayer = L.geoJSON(mapaDatos, {
                style: estiloPoligono,
                onEachFeature: function(feature, layer) {
                    layer.on({
                        mouseover: (e) => { e.target.setStyle({ weight: 2, color: '#fff', fillOpacity: 1 }); e.target.bringToFront(); },
                        mouseout: (e) => { geojsonLayer.resetStyle(e.target); },
                        click: (e) => { 
                            map.flyToBounds(e.target.getBounds(), {padding: [100,100], maxZoom: 16});
                            procesarExpediente(feature.properties); 
                        }
                    });
                }
            }).addTo(map);
        }

        function cambiarCapa() {
            algoritmoActual = document.getElementById('layer-selector').value;
            renderizarCapa();
            actualizarLeyenda();
            cerrarPanel();
        }

        function actualizarLeyenda() {
            let cfg = algoritmos[algoritmoActual];
            document.getElementById('leg-title').innerText = cfg.titulo;
            document.getElementById('leg-desc').innerText = cfg.desc;
            
            let divColores = document.getElementById('leg-colors');
            divColores.innerHTML = '';
            cfg.paleta.forEach(c => divColores.innerHTML += `<div style="background:${c}"></div>`);

            let maxStr = cfg.formato === '%' ? Math.round(cfg.maximo*100)+'%' : cfg.maximo + ' ' + cfg.formato;
            document.getElementById('leg-max').innerText = "> " + maxStr;
        }

        function procesarExpediente(p) {
            let d = {};
            for (let k in p) { if(traductor[k]) d[traductor[k]] = p[k]; }
            
            // Ejecutar IREM para el score principal
            let scoreIREM = algoritmos['irem'].calc(d);
            let scoreFmt = isNaN(scoreIREM) ? 0 : scoreIREM.toFixed(1);
            document.getElementById('res-score').innerText = scoreFmt;
            
            let label = scoreIREM > 75 ? 'Riesgo Cr√≠tico' : scoreIREM > 50 ? 'Riesgo Alto' : scoreIREM > 25 ? 'Riesgo Moderado' : 'Bajo Riesgo';
            document.getElementById('res-score-label').innerText = label;

            // Actualizar Barras de Progreso Desagregadas
            const setBar = (id, val, max = 100) => {
                let p = Math.round(val || 0);
                document.getElementById('m-'+id).innerText = p + '%';
                document.getElementById('b-'+id).style.width = Math.min(p, 100) + '%';
            };

            setBar('jovenes', (d.porcentaje_menor20 || 0) * 100);
            setBar('edu', (d.educacion_superior || 0) * 100);
            setBar('net', (1 - (d.viviendas_tics_internet || 0)) * 100); // Aislamiento
            setBar('dep', (d.dependencia_economica || 0)); // Ya viene en base 100 (ej 120%)

            document.getElementById('m-pob').innerText = Math.round(d.personas || 0);
            document.getElementById('m-mig').innerText = Math.round((d.poblacion_migrante || 0) * 100) + '%';

            document.getElementById('ui-analytics').classList.add('active');
        }

        function cerrarPanel() { document.getElementById('ui-analytics').classList.remove('active'); }
    </script>
</body>
</html>
