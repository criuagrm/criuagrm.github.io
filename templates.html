<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Generador de marcos ‚Äî CIRCPyCS</title>
  <style>
    :root{
      --brand:#003366; /* azul CIRCPyCS */
      --ink:#0f172a;   /* texto oscuro */
      --paper:#ffffff; /* blanco */
      --bg:#0b1220;    /* fondo app */
      --panel:#121a2b; /* panel controles */
      --soft:0 12px 30px rgba(2,6,23,.28);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b1220,#0e1526);color:#e6eef7;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .app{display:grid;grid-template-columns:360px 1fr;min-height:100%;}
    aside{background:var(--panel);padding:18px 16px 16px;border-right:1px solid rgba(255,255,255,.06)}
    main{display:flex;flex-direction:column}
    header{display:flex;align-items:center;gap:12px;padding:14px 18px;border-bottom:1px solid rgba(255,255,255,.06)}
    header .badge{width:36px;height:36px;border-radius:10px;background:var(--brand);display:grid;place-items:center;font-weight:800}
    h1{font-size:16px;margin:0}

    .controls{display:grid;gap:14px}
    .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:12px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    label{display:block;font-size:12px;color:#a5b4c7;margin:6px 0}
    input[type="text"], select, input[type="number"]{
      width:100%;padding:10px 12px;border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);border-radius:10px;color:#e6eef7
    }
    input[type="range"]{width:100%}
    input[type="file"]{width:100%}
    button{appearance:none;border:0;background:var(--brand);color:#fff;font-weight:700;padding:11px 12px;border-radius:12px;box-shadow:var(--soft);cursor:pointer}
    button.secondary{background:transparent;border:1px solid rgba(255,255,255,.16);color:#d7e2f3}
    button:disabled{opacity:.45;cursor:not-allowed}

    .stage{flex:1;display:flex;align-items:center;justify-content:center;position:relative;padding:16px}
    .canvasWrap{position:relative;background:#101827;border:1px dashed rgba(255,255,255,.2);border-radius:16px;box-shadow:0 20px 50px rgba(0,0,0,.35)}
    .canvasWrap .live{position:relative;overflow:hidden;border-radius:14px}
    .hint{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);font-size:12px;color:#9fb3cc;background:rgba(0,0,0,.4);padding:6px 10px;border-radius:10px}

    .footer{display:flex;gap:10px;padding:14px 18px;border-top:1px solid rgba(255,255,255,.06)}

    /* Hide scrollbars on number inputs */
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button{ -webkit-appearance: none; margin: 0; }
  </style>
</head>
<body>
  <div class="app">
    <aside>
      <header style="padding:0 0 12px 0;border:0">
        <div class="badge">C</div>
        <div>
          <h1>CIRCPyCS ‚Äî Generador</h1>
          <div style="font-size:12px;color:#9fb3cc">Sube una foto, elige marco y descarga en PNG</div>
        </div>
      </header>
      <div class="controls">
        <div class="card">
          <label>Imagen (JPG/PNG) ‚Äî arrastra o selecciona</label>
          <input id="uploader" type="file" accept="image/*" />
          <div class="row">
            <div>
              <label>Marco</label>
              <select id="frameSel">
                <option value="classic">Cl√°sico</option>
                <option value="lateral">Lateral</option>
                <option value="sello">Sello</option>
              </select>
            </div>
            <div>
              <label>Relaci√≥n</label>
              <select id="ratioSel">
                <option value="1:1">1:1</option>
                <option value="4:5">4:5</option>
                <option value="16:9">16:9</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div>
              <label>Exportar a</label>
              <select id="sizeSel" title="Resoluci√≥n base">
                <option value="auto">Sugerida</option>
                <option value="1080">Ancho 1080 px</option>
                <option value="1920">Ancho 1920 px</option>
                <option value="2560">Ancho 2560 px</option>
                <option value="3840">Ancho 3840 px (4K)</option>
              </select>
            </div>
            <div>
              <label>Escala (DPI)</label>
              <select id="scaleSel">
                <option value="1">1√ó</option>
                <option value="2" selected>2√ó</option>
                <option value="3">3√ó</option>
                <option value="4">4√ó</option>
              </select>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="row">
            <div>
              <label>Zoom (rueda del mouse)</label>
              <input id="zoomRange" type="range" min="0.2" max="4" step="0.01" value="1" />
            </div>
            <div>
              <label>Rotaci√≥n</label>
              <input id="rotRange" type="range" min="-45" max="45" step="0.1" value="0" />
            </div>
          </div>
          <div class="row">
            <button id="fitBtn" class="secondary">Ajustar a marco</button>
            <button id="resetBtn" class="secondary">Reiniciar vista</button>
          </div>
        </div>

        <div class="card">
          <label>T√≠tulo</label>
          <input id="titleInput" type="text" placeholder="Centro de Investigaci√≥n Regional en Ciencia Pol√≠tica..." value="CIRCPyCS ‚Äî UAGRM" />
          <label>Subt√≠tulo</label>
          <input id="subtitleInput" type="text" placeholder="Evento ¬∑ Autor/Equipo ¬∑ Fecha" value="T√≠tulo del evento ¬∑ Autor/Equipo ¬∑ Fecha" />
          <div class="row" style="margin-top:8px">
            <button id="dlBtn">Descargar PNG</button>
            <button id="dlTransparentBtn" class="secondary" title="Exporta sin foto (solo marco)">Solo marco</button>
          </div>
        </div>

        <div style="font-size:12px;color:#9fb3cc">Consejos: arrastra para mover la foto. Usa la rueda para zoom. Mant√©n <code>Shift</code> para zoom m√°s fino.</div>
      </div>
    </aside>

    <main>
      <header>
        <div class="badge" style="background:#15233c">üñºÔ∏è</div>
        <div>
          <div style="font-weight:700">Vista previa</div>
          <div style="font-size:12px;color:#9fb3cc">Lo que ves es lo que se descarga (WYSIWYG)</div>
        </div>
      </header>
      <div class="stage">
        <div class="canvasWrap">
          <div id="live" class="live" style="width:540px;height:540px">
            <!-- Fondo (foto) -->
            <img id="photo" alt="foto" style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%) scale(1);transform-origin:center center;will-change:transform;user-select:none;pointer-events:none;display:none" />
            <!-- Capa de marco (SVG inyectado) -->
            <div id="overlay" style="position:absolute;inset:0"></div>
          </div>
          <div class="hint">Arrastra para mover ¬∑ Rueda para zoom</div>
        </div>
      </div>
      <div class="footer">
        <div style="font-size:12px;color:#9fb3cc">¬© CIRCPyCS ¬∑ Exportaci√≥n con suavizado de alta calidad</div>
      </div>
    </main>
  </div>

  <!-- ===================== SVG TEMPLATES ===================== -->
  <template id="tpl-classic-1:1"><![CDATA[
  <svg viewBox="0 0 1080 1080" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <linearGradient id="gradBottom" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="var(--brand)" stop-opacity="0.92"/>
        <stop offset="100%" stop-color="#00264d" stop-opacity="0.98"/>
      </linearGradient>
      <clipPath id="clip">
        <rect x="12" y="12" width="1056" height="1056" rx="28" ry="28"/>
      </clipPath>
    </defs>
    <rect x="12" y="12" width="1056" height="1056" rx="28" ry="28" fill="none" stroke="var(--brand)" stroke-width="8"/>
    <g clip-path="url(#clip)">
      <rect x="0" y="900" width="1080" height="180" fill="url(#gradBottom)"/>
      <g>
        <rect x="36" y="36" width="280" height="120" rx="16" fill="var(--paper)"/>
        <rect x="52" y="52" width="88" height="88" rx="12" fill="var(--brand)"/>
        <text x="152" y="105" font-size="36" font-weight="700" fill="var(--ink)">CIRCPyCS</text>
      </g>
      <text x="48" y="972" fill="#ffffff" font-size="36" font-weight="700">{{TITLE}}</text>
      <text x="48" y="1016" fill="#e6eef7" font-size="26">{{SUBTITLE}}</text>
    </g>
  </svg>
  ]]></template>

  <template id="tpl-classic-4:5"><![CDATA[
  <svg viewBox="0 0 1080 1350" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <linearGradient id="gradBottom45" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="var(--brand)" stop-opacity="0.92"/>
        <stop offset="100%" stop-color="#00264d" stop-opacity="0.98"/>
      </linearGradient>
      <clipPath id="clip">
        <rect x="12" y="12" width="1056" height="1326" rx="28" ry="28"/>
      </clipPath>
    </defs>
    <rect x="12" y="12" width="1056" height="1326" rx="28" ry="28" fill="none" stroke="var(--brand)" stroke-width="8"/>
    <g clip-path="url(#clip)">
      <rect x="0" y="1150" width="1080" height="200" fill="url(#gradBottom45)"/>
      <g>
        <rect x="36" y="36" width="300" height="120" rx="16" fill="var(--paper)"/>
        <rect x="52" y="52" width="88" height="88" rx="12" fill="var(--brand)"/>
        <text x="152" y="105" font-size="36" font-weight="700" fill="var(--ink)">CIRCPyCS</text>
      </g>
      <text x="48" y="1216" fill="#ffffff" font-size="38" font-weight="700">{{TITLE}}</text>
      <text x="48" y="1260" fill="#e6eef7" font-size="26">{{SUBTITLE}}</text>
    </g>
  </svg>
  ]]></template>

  <template id="tpl-classic-16:9"><![CDATA[
  <svg viewBox="0 0 1920 1080" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <linearGradient id="gradBottom169" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="var(--brand)" stop-opacity="0.92"/>
        <stop offset="100%" stop-color="#00264d" stop-opacity="0.98"/>
      </linearGradient>
      <clipPath id="clip">
        <rect x="16" y="16" width="1888" height="1048" rx="28" ry="28"/>
      </clipPath>
    </defs>
    <rect x="16" y="16" width="1888" height="1048" rx="28" ry="28" fill="none" stroke="var(--brand)" stroke-width="8"/>
    <g clip-path="url(#clip)">
      <rect x="0" y="900" width="1920" height="180" fill="url(#gradBottom169)"/>
      <g>
        <rect x="36" y="36" width="320" height="120" rx="16" fill="var(--paper)"/>
        <rect x="52" y="52" width="88" height="88" rx="12" fill="var(--brand)"/>
        <text x="154" y="104" font-size="40" font-weight="700" fill="var(--ink)">CIRCPyCS</text>
      </g>
      <text x="48" y="972" fill="#ffffff" font-size="40" font-weight="700">{{TITLE}}</text>
      <text x="48" y="1018" fill="#e6eef7" font-size="28">{{SUBTITLE}}</text>
    </g>
  </svg>
  ]]></template>

  <template id="tpl-lateral-1:1"><![CDATA[
  <svg viewBox="0 0 1080 1080" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <linearGradient id="gradSide" x1="0" y1="0" x2="1" y2="0">
        <stop offset="0%" stop-color="#001a33"/>
        <stop offset="100%" stop-color="var(--brand)"/>
      </linearGradient>
      <clipPath id="clip"><rect x="12" y="12" width="1056" height="1056" rx="28" ry="28"/></clipPath>
    </defs>
    <rect x="12" y="12" width="1056" height="1056" rx="28" ry="28" fill="none" stroke="var(--brand)" stroke-width="8"/>
    <g clip-path="url(#clip)">
      <rect x="0" y="0" width="180" height="1080" fill="url(#gradSide)"/>
      <rect x="36" y="36" width="108" height="108" rx="14" fill="var(--paper)"/>
      <text x="90" y="106" text-anchor="middle" font-size="28" font-weight="800" fill="var(--brand)">C</text>
      <g transform="translate(140,540) rotate(-90)">
        <text x="0" y="0" fill="#ffffff" font-size="40" font-weight="700" text-anchor="middle" letter-spacing="2">CIRCPyCS ‚Äî UAGRM</text>
      </g>
      <g transform="translate(660,900)">
        <rect width="384" height="144" rx="16" fill="rgba(255,255,255,0.92)"/>
        <text x="24" y="58" font-size="34" font-weight="700" fill="var(--ink)">{{TITLE}}</text>
        <text x="24" y="98" font-size="24" fill="#334155">{{SUBTITLE}}</text>
      </g>
    </g>
  </svg>
  ]]></template>

  <template id="tpl-lateral-4:5"><![CDATA[
  <svg viewBox="0 0 1080 1350" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <linearGradient id="gradSide45" x1="0" y1="0" x2="1" y2="0">
        <stop offset="0%" stop-color="#001a33"/>
        <stop offset="100%" stop-color="var(--brand)"/>
      </linearGradient>
      <clipPath id="clip"><rect x="12" y="12" width="1056" height="1326" rx="28" ry="28"/></clipPath>
    </defs>
    <rect x="12" y="12" width="1056" height="1326" rx="28" ry="28" fill="none" stroke="var(--brand)" stroke-width="8"/>
    <g clip-path="url(#clip)">
      <rect x="0" y="0" width="180" height="1350" fill="url(#gradSide45)"/>
      <rect x="36" y="36" width="116" height="116" rx="16" fill="var(--paper)"/>
      <text x="94" y="108" text-anchor="middle" font-size="30" font-weight="800" fill="var(--brand)">C</text>
      <g transform="translate(140,675) rotate(-90)">
        <text x="0" y="0" fill="#ffffff" font-size="44" font-weight="700" text-anchor="middle" letter-spacing="2">CIRCPyCS ‚Äî UAGRM</text>
      </g>
      <g transform="translate(600,1150)">
        <rect width="456" height="156" rx="18" fill="rgba(255,255,255,0.92)"/>
        <text x="24" y="64" font-size="36" font-weight="700" fill="var(--ink)">{{TITLE}}</text>
        <text x="24" y="106" font-size="26" fill="#334155">{{SUBTITLE}}</text>
      </g>
    </g>
  </svg>
  ]]></template>

  <template id="tpl-lateral-16:9"><![CDATA[
  <svg viewBox="0 0 1920 1080" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <linearGradient id="gradSide169" x1="0" y1="0" x2="1" y2="0">
        <stop offset="0%" stop-color="#001a33"/>
        <stop offset="100%" stop-color="var(--brand)"/>
      </linearGradient>
      <clipPath id="clip"><rect x="16" y="16" width="1888" height="1048" rx="28" ry="28"/></clipPath>
    </defs>
    <rect x="16" y="16" width="1888" height="1048" rx="28" ry="28" fill="none" stroke="var(--brand)" stroke-width="8"/>
    <g clip-path="url(#clip)">
      <rect x="0" y="0" width="240" height="1080" fill="url(#gradSide169)"/>
      <rect x="36" y="36" width="136" height="136" rx="18" fill="var(--paper)"/>
      <text x="104" y="118" text-anchor="middle" font-size="32" font-weight="800" fill="var(--brand)">C</text>
      <g transform="translate(200,540) rotate(-90)">
        <text x="0" y="0" fill="#ffffff" font-size="48" font-weight="700" text-anchor="middle" letter-spacing="2">CIRCPyCS ‚Äî UAGRM</text>
      </g>
      <g transform="translate(1320,880)">
        <rect width="520" height="160" rx="18" fill="rgba(255,255,255,0.92)"/>
        <text x="24" y="66" font-size="38" font-weight="700" fill="var(--ink)">{{TITLE}}</text>
        <text x="24" y="110" font-size="28" fill="#334155">{{SUBTITLE}}</text>
      </g>
    </g>
  </svg>
  ]]></template>

  <template id="tpl-sello-1:1"><![CDATA[
  <svg viewBox="0 0 1080 1080" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <clipPath id="clip"><rect x="12" y="12" width="1056" height="1056" rx="28" ry="28"/></clipPath>
      <filter id="shadowBadge" x="-50%" y="-50%" width="200%" height="200%">
        <feDropShadow dx="0" dy="4" stdDeviation="6" flood-color="#001a33" flood-opacity="0.35"/>
      </filter>
    </defs>
    <rect x="16" y="16" width="1048" height="1048" rx="28" ry="28" fill="none" stroke="#ffffff" stroke-opacity="0.55" stroke-width="2" stroke-dasharray="6 10"/>
    <rect x="12" y="12" width="1056" height="1056" rx="28" ry="28" fill="none" stroke="var(--brand)" stroke-width="6"/>
    <g clip-path="url(#clip)">
      <g transform="translate(840,84)" filter="url(#shadowBadge)">
        <circle cx="120" cy="120" r="120" fill="var(--brand)"/>
        <circle cx="120" cy="120" r="108" fill="none" stroke="#ffffff" stroke-width="3" opacity="0.7"/>
        <text x="120" y="112" text-anchor="middle" font-size="40" fill="#ffffff" font-weight="800">CIRCPyCS</text>
        <text x="120" y="152" text-anchor="middle" font-size="22" fill="#e6eef7">UAGRM</text>
      </g>
      <g transform="translate(36,930)">
        <rect width="520" height="96" rx="48" fill="rgba(0,26,51,.85)"/>
        <text x="24" y="60" font-size="30" fill="#ffffff" font-weight="700">{{TITLE}}</text>
      </g>
      <text x="48" y="1016" fill="#e6eef7" font-size="24">{{SUBTITLE}}</text>
    </g>
  </svg>
  ]]></template>

  <template id="tpl-sello-4:5"><![CDATA[
  <svg viewBox="0 0 1080 1350" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <clipPath id="clip"><rect x="12" y="12" width="1056" height="1326" rx="28" ry="28"/></clipPath>
      <filter id="shadowBadge" x="-50%" y="-50%" width="200%" height="200%">
        <feDropShadow dx="0" dy="4" stdDeviation="6" flood-color="#001a33" flood-opacity="0.35"/>
      </filter>
    </defs>
    <rect x="16" y="16" width="1048" height="1318" rx="28" ry="28" fill="none" stroke="#ffffff" stroke-opacity="0.55" stroke-width="2" stroke-dasharray="6 10"/>
    <rect x="12" y="12" width="1056" height="1326" rx="28" ry="28" fill="none" stroke="var(--brand)" stroke-width="6"/>
    <g clip-path="url(#clip)">
      <g transform="translate(804,84)" filter="url(#shadowBadge)">
        <circle cx="120" cy="120" r="120" fill="var(--brand)"/>
        <circle cx="120" cy="120" r="108" fill="none" stroke="#ffffff" stroke-width="3" opacity="0.7"/>
        <text x="120" y="112" text-anchor="middle" font-size="40" fill="#ffffff" font-weight="800">CIRCPyCS</text>
        <text x="120" y="152" text-anchor="middle" font-size="22" fill="#e6eef7">UAGRM</text>
      </g>
      <g transform="translate(36,1170)">
        <rect width="680" height="102" rx="50" fill="rgba(0,26,51,.85)"/>
        <text x="24" y="64" font-size="32" fill="#ffffff" font-weight="700">{{TITLE}}</text>
      </g>
      <text x="48" y="1252" fill="#e6eef7" font-size="26">{{SUBTITLE}}</text>
    </g>
  </svg>
  ]]></template>

  <template id="tpl-sello-16:9"><![CDATA[
  <svg viewBox="0 0 1920 1080" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <clipPath id="clip"><rect x="16" y="16" width="1888" height="1048" rx="28" ry="28"/></clipPath>
      <filter id="shadowBadge" x="-50%" y="-50%" width="200%" height="200%">
        <feDropShadow dx="0" dy="4" stdDeviation="6" flood-color="#001a33" flood-opacity="0.35"/>
      </filter>
    </defs>
    <rect x="20" y="20" width="1880" height="1040" rx="28" ry="28" fill="none" stroke="#ffffff" stroke-opacity="0.55" stroke-width="2" stroke-dasharray="6 10"/>
    <rect x="16" y="16" width="1888" height="1048" rx="28" ry="28" fill="none" stroke="var(--brand)" stroke-width="6"/>
    <g clip-path="url(#clip)">
      <g transform="translate(1640,84)" filter="url(#shadowBadge)">
        <circle cx="120" cy="120" r="120" fill="var(--brand)"/>
        <circle cx="120" cy="120" r="108" fill="none" stroke="#ffffff" stroke-width="3" opacity="0.7"/>
        <text x="120" y="112" text-anchor="middle" font-size="40" fill="#ffffff" font-weight="800">CIRCPyCS</text>
        <text x="120" y="152" text-anchor="middle" font-size="22" fill="#e6eef7">UAGRM</text>
      </g>
      <g transform="translate(36,900)">
        <rect width="800" height="108" rx="54" fill="rgba(0,26,51,.85)"/>
        <text x="24" y="68" font-size="34" fill="#ffffff" font-weight="700">{{TITLE}}</text>
      </g>
      <text x="48" y="1000" fill="#e6eef7" font-size="26">{{SUBTITLE}}</text>
    </g>
  </svg>
  ]]></template>

  <script>
  (function(){
    const live = document.getElementById('live');
    const photo = document.getElementById('photo');
    const overlay = document.getElementById('overlay');
    const uploader = document.getElementById('uploader');
    const frameSel = document.getElementById('frameSel');
    const ratioSel = document.getElementById('ratioSel');
    const sizeSel  = document.getElementById('sizeSel');
    const scaleSel = document.getElementById('scaleSel');
    const titleInput = document.getElementById('titleInput');
    const subtitleInput = document.getElementById('subtitleInput');
    const zoomRange = document.getElementById('zoomRange');
    const rotRange  = document.getElementById('rotRange');
    const fitBtn = document.getElementById('fitBtn');
    const resetBtn = document.getElementById('resetBtn');
    const dlBtn = document.getElementById('dlBtn');
    const dlTransparentBtn = document.getElementById('dlTransparentBtn');

    const BASE = { '1:1': {w:1080,h:1080}, '4:5': {w:1080,h:1350}, '16:9': {w:1920,h:1080} };

    function tplId(frame, ratio){ return `tpl-${frame}-${ratio}`; }

    function buildSVG(frame, ratio, title, subtitle){
      const t = document.getElementById(tplId(frame, ratio));
      if(!t){ console.warn('Template no encontrado', frame, ratio); return ''; }
      let svg = t.innerHTML.trim();
      svg = svg.replaceAll('{{TITLE}}', escapeXML(title || ''))
               .replaceAll('{{SUBTITLE}}', escapeXML(subtitle || ''));
      return svg;
    }

    function escapeXML(str){
      return String(str).replace(/[&<>"']/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&apos;"}[s]));
    }

    function setRatio(r){
      const {w,h} = BASE[r];
      const scale = 540 / Math.max(w,h) * (r==='4:5'? (540/675) : 1); // keep preview pleasant
      let pw, ph;
      if(r==='1:1'){ pw=540; ph=540; }
      else if(r==='4:5'){ pw=540; ph=675; }
      else { pw=960; ph=540; }
      live.style.width = pw+'px';
      live.style.height= ph+'px';
      overlay.innerHTML = buildSVG(frameSel.value, r, titleInput.value, subtitleInput.value);
    }

    function updateOverlay(){
      overlay.innerHTML = buildSVG(frameSel.value, ratioSel.value, titleInput.value, subtitleInput.value);
    }

    // Photo state
    const state = { scale:1, rot:0, dx:0, dy:0, img:null };

    function applyTransform(){
      if(!state.img){ photo.style.display='none'; return; }
      photo.style.display='block';
      photo.style.transform = `translate(calc(-50% + ${state.dx}px), calc(-50% + ${state.dy}px)) rotate(${state.rot}deg) scale(${state.scale})`;
    }

    // Fit image to cover the frame
    function fitToFrame(){
      if(!state.img) return;
      const r = ratioSel.value; const {w,h} = BASE[r];
      const frameRatio = w/h;
      const imgRatio = state.img.naturalWidth/state.img.naturalHeight;
      if(imgRatio > frameRatio){ // image wider -> fit height
        state.scale = (h / state.img.naturalHeight);
      } else {
        state.scale = (w / state.img.naturalWidth);
      }
      // scale down for preview dimensions
      const prevW = live.clientWidth, prevH = live.clientHeight;
      const kx = prevW / w, ky = prevH / h; const k = Math.max(kx,ky);
      state.scale *= k; state.dx = 0; state.dy = 0; state.rot = 0;
      zoomRange.value = 1; rotRange.value = 0;
      applyTransform();
    }

    function resetView(){ if(!state.img) return; state.scale=1; state.dx=state.dy=0; state.rot=0; zoomRange.value=1; rotRange.value=0; applyTransform(); }

    // Drag handling
    let dragging=false, lastX=0, lastY=0;
    live.addEventListener('mousedown', e=>{ dragging=true; lastX=e.clientX; lastY=e.clientY; });
    window.addEventListener('mouseup', ()=> dragging=false);
    window.addEventListener('mousemove', e=>{
      if(!dragging || !state.img) return;
      state.dx += (e.clientX-lastX); state.dy += (e.clientY-lastY);
      lastX=e.clientX; lastY=e.clientY; applyTransform();
    });

    // Wheel zoom
    live.addEventListener('wheel', e=>{
      if(!state.img) return; e.preventDefault();
      const delta = Math.sign(e.deltaY) * (e.shiftKey? 0.02 : 0.08);
      state.scale = Math.min(4, Math.max(0.2, state.scale*(1 - delta)));
      zoomRange.value = state.scale; applyTransform();
    }, {passive:false});

    zoomRange.addEventListener('input', ()=>{ state.scale = parseFloat(zoomRange.value); applyTransform(); });
    rotRange.addEventListener('input', ()=>{ state.rot = parseFloat(rotRange.value); applyTransform(); });

    frameSel.addEventListener('change', ()=>{ updateOverlay(); });
    ratioSel.addEventListener('change', ()=>{ setRatio(ratioSel.value); fitToFrame(); });
    titleInput.addEventListener('input', updateOverlay);
    subtitleInput.addEventListener('input', updateOverlay);

    fitBtn.addEventListener('click', (e)=>{ e.preventDefault(); fitToFrame(); });
    resetBtn.addEventListener('click', (e)=>{ e.preventDefault(); resetView(); });

    // Upload
    uploader.addEventListener('change', (e)=>{
      const f = e.target.files && e.target.files[0]; if(!f) return;
      const url = URL.createObjectURL(f);
      const img = new Image();
      img.onload = ()=>{
        URL.revokeObjectURL(url);
        state.img = img; photo.src = img.src; applyTransform(); fitToFrame();
      };
      img.src = url;
    });

    // Exporter
    async function exportPNG({transparent=false}={}){
      const r = ratioSel.value; const {w,h} = BASE[r];
      const scale = parseInt(scaleSel.value,10) || 1;
      let targetW;
      if(sizeSel.value==='auto') targetW = (r==='16:9'?1920:1080);
      else targetW = parseInt(sizeSel.value,10);
      const targetH = Math.round(targetW * (h/w));

      const canvas = document.createElement('canvas');
      canvas.width = Math.round(targetW*scale);
      canvas.height= Math.round(targetH*scale);
      const ctx = canvas.getContext('2d');
      ctx.imageSmoothingEnabled = true; ctx.imageSmoothingQuality = 'high';

      // Draw photo
      if(!transparent && state.img){
        // Map preview transform into output pixels
        // Compute scale from natural to preview, then to output
        const prevW = live.clientWidth, prevH = live.clientHeight;
        const kx = prevW / w, ky = prevH / h; const k = Math.max(kx,ky);
        const baseScale = k; // preview pixels per SVG unit
        const totalScale = state.scale / baseScale; // relative to SVG units

        const cx = (canvas.width)/2 + state.dx*scale*(targetW/prevW);
        const cy = (canvas.height)/2 + state.dy*scale*(targetH/prevH);

        ctx.save();
        ctx.translate(cx, cy);
        ctx.rotate(state.rot*Math.PI/180);
        ctx.scale(totalScale*scale*(targetW/targetW), totalScale*scale*(targetH/targetH));
        const iw = state.img.naturalWidth, ih = state.img.naturalHeight;
        ctx.drawImage(state.img, -iw/2, -ih/2, iw, ih);
        ctx.restore();
      } else {
        // transparent background
        ctx.clearRect(0,0,canvas.width,canvas.height);
      }

      // Draw overlay SVG
      const svgText = buildSVG(frameSel.value, r, titleInput.value, subtitleInput.value)
        .replace('<svg', `<svg xmlns=\"http://www.w3.org/2000/svg\"`)
        .replace('</svg>','</svg>');
      const blob = new Blob([svgText], {type:'image/svg+xml'});
      const url = URL.createObjectURL(blob);
      await new Promise((res,rej)=>{
        const img = new Image();
        img.onload = ()=>{ ctx.drawImage(img, 0, 0, canvas.width, canvas.height); URL.revokeObjectURL(url); res(); };
        img.onerror = rej; img.src = url;
      });

      const pngURL = canvas.toDataURL('image/png');
      const a = document.createElement('a');
      const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
      a.download = `CIRCPyCS_${frameSel.value}_${r}_${targetW}w_${scale}x_${stamp}.png`;
      a.href = pngURL; a.click();
    }

    dlBtn.addEventListener('click', (e)=>{ e.preventDefault(); exportPNG({transparent:false}); });
    dlTransparentBtn.addEventListener('click', (e)=>{ e.preventDefault(); exportPNG({transparent:true}); });

    // init
    setRatio(ratioSel.value); updateOverlay();
  })();
  </script>
</body>
</html>
